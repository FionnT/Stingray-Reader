
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>12.2. Application Level Data Validation Technique &#8212; The Stingray Schema-Based File Reader</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="12.3. Data Profiling Demonstration" href="profile.html" />
    <link rel="prev" title="12.1. Unit Level Validation for Application and Data" href="data_quality.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="application-level-data-validation-technique">
<span id="demo-validate"></span><h1>12.2. Application Level Data Validation Technique<a class="headerlink" href="#application-level-data-validation-technique" title="Permalink to this headline">¶</a></h1>
<p>We validate that that a file actually matches a schema through a three-part valiation process.
We looked at the first two parts in <a class="reference internal" href="data_quality.html#demo-sqa"><span class="std std-ref">Unit Level Validation for Application and Data</span></a>.</p>
<ul class="simple">
<li>Validate an application’s use of a schema via conventional unit testing.</li>
<li>Validate file conformance to a schema via “live-file testing”.</li>
</ul>
<p>In this section we’ll show how to include
a <strong>File Validation</strong> mode in every file processing application.</p>
<p>Having a validation mode means that we must disentangle all of the persistent state change
operations from the input and processing in our application.
The “normal” mode uses persistent changes based on the output.
The validation mode doesn’t make persistent changes;
it can be viewed as a sort of “dry run”: all the processing; none of the writing.</p>
<p>We’ll do this with a combination of the <strong>Command</strong> and the <strong>Strategy</strong> design patterns.
We’ll create applications
which validate their input file and have a simple plug-in strategy for
doing any final persistent processing on that file.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Simple File Structures</p>
<p>This validation is designed for simple CSV files with embedded schema.
The assumption is that each sheet within the workbook
has a consistent structure. There’s no filter applied to pass
or reject sheets.</p>
<p class="last">Some kind of extension to this application is required
to handle named sheets within a more complex workbook or
to handle sheets which have no header.</p>
</div>
<div class="section" id="state-change-commands">
<h2>12.2.1. State Change Commands<a class="headerlink" href="#state-change-commands" title="Permalink to this headline">¶</a></h2>
<p>The <strong>Command</strong> design patterns is helpful for isolating state changes in an application.</p>
<p>Each change (create, update, delete) creates a <strong>Command</strong>.
In validate mode, these are created but not applied.
In “normal” processing mode, these are created and applied.</p>
<p>For Extract-Transform-Load (ETL) applications, the commands are the loads.</p>
<p>For create-retrieve-update-delete (CRUD) programs, the commands are variations on create, update and delete.</p>
<p>For data warehouse dimensional conformance applications, the
command may be a slowly-changing dimension (SCD) algorithm that does insert
or update (or both) into a dimension table.</p>
<p>For applications that involve a (potentially) complex multi-step workflow with
(potentially) several state changes along the way, each change is a command.</p>
<p>In some cases, a fairly sophisticated <strong>Command</strong> class hierarchy is
called for.  In other cases, however, the individual commands can be
merged into the validate <strong>Strategy</strong> object as methods.</p>
</div>
<div class="section" id="persistence-context-manager">
<h2>12.2.2. Persistence Context Manager<a class="headerlink" href="#persistence-context-manager" title="Permalink to this headline">¶</a></h2>
<p>One good way to distinguish between persistent and transient processing
is to use a <strong>Strategy</strong> class hierarchy.
This will have two variations on the persistent state changes.</p>
<ul class="simple">
<li><strong>Validate</strong>.  This subclass does nothing.</li>
<li><strong>Process</strong>.  This subclass actually makes persistent state changes.</li>
</ul>
<p>Combining the validate <strong>Strategy</strong> with the state change <strong>Command</strong>
leads to class similar to the following.</p>
<p>The superclass does the persistent processing. This is the “normal” mode
that makes proper changes to the filesystem or database.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Persistent_Processing</span><span class="p">:</span>
    <span class="n">stop_on_exception</span><span class="o">=</span> <span class="kc">True</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">context</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">=</span> <span class="n">context</span>
    <span class="k">def</span> <span class="nf">save_this</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">this_instance</span> <span class="p">):</span>
        <span class="n">this_instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">save_that</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">this_instance</span> <span class="p">):</span>
        <span class="n">that_instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>We’ll fold in the Context Manager interface.  This is a polite way to support
any preparation or finalization.  For example, we would use the context manager
to create database connections, or finalize file system operations, etc.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
<span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="p">):</span>
    <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Here’s a subclass which implements a safe, do-nothing strategy.  This
is used for “validate-mode” processing. It’s a subclass that turns off
persistence.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Validate_Only_Processing</span><span class="p">(</span> <span class="n">Persistent_Processing</span> <span class="p">):</span>
    <span class="n">stop_on_exception</span><span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">context</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">=</span> <span class="n">context</span>
    <span class="k">def</span> <span class="nf">save_this</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">this_instance</span> <span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">save_that</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">this_instance</span> <span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Alternate Design</p>
<p>We could revise this design to make the validation mode the superclass.
The subclass could then add the persistence features.</p>
<p>This doesn’t actually work out well in practice.</p>
<p>Why not?</p>
<p>It’s too easy to overlook things in the validation mode superclass.
The normal persistent processing subclass then winds up having a <strong>lot</strong> of extra
stuff added to it.</p>
<p class="last">The design winds up somewhat better looking if we remove persistence.</p>
</div>
<p>Having these two classes allows us to configure our
application processing as follows. We can define high-level functions
like <code class="xref py py-func docutils literal notranslate"><span class="pre">validate()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">process()</span></code> that are identical
except for the context manager that’s used.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">some_context</span> <span class="p">):</span>
    <span class="k">with</span> <span class="n">Validate_Only_Processing</span><span class="p">(</span> <span class="n">some_context</span> <span class="p">)</span> <span class="k">as</span> <span class="n">mode</span><span class="p">:</span>
        <span class="n">counts</span><span class="o">=</span> <span class="n">process_sheet</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">mode</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">counts</span>

<span class="k">def</span> <span class="nf">process</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">some_context</span> <span class="p">):</span>
    <span class="k">with</span> <span class="n">Persistent_Processing</span><span class="p">(</span> <span class="n">some_context</span> <span class="p">)</span> <span class="k">as</span> <span class="n">mode</span><span class="p">:</span>
        <span class="n">counts</span><span class="o">=</span> <span class="n">process_sheet</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">mode</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">counts</span>
</pre></div>
</div>
<p>Both of these <code class="xref py py-func docutils literal notranslate"><span class="pre">validate()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">process()</span></code> functions
rely on a common <code class="xref py py-func docutils literal notranslate"><span class="pre">process_sheeet()</span></code>. This is agnostic of the
processing context; it simply does its work.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_sheet</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">persistence</span> <span class="p">):</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">rows_as_dict_iter</span><span class="p">(</span><span class="n">sheet</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">this</span><span class="o">=</span> <span class="n">build_this</span><span class="p">(</span> <span class="n">row</span> <span class="p">)</span>
            <span class="n">f</span><span class="o">=</span> <span class="n">ThisForm</span><span class="p">(</span> <span class="n">this</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">persistence</span><span class="o">.</span><span class="n">save_this</span><span class="p">(</span> <span class="n">this</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">persistence</span><span class="o">.</span><span class="n">stop_on_exception</span><span class="p">:</span> <span class="k">raise</span>
</pre></div>
</div>
<p>This allows us to effectively unit test by creating a
mock version of <code class="docutils literal notranslate"><span class="pre">Persistent_Processing</span></code> and invoking
the <code class="docutils literal notranslate"><span class="pre">process_sheet</span></code> function.</p>
</div>
<div class="section" id="example-application">
<h2>12.2.3. Example Application<a class="headerlink" href="#example-application" title="Permalink to this headline">¶</a></h2>
<p>We depend on a number of Python libraries.  Plus, of course, we’re
creating workbooks, working with sheets and schema.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">stingray.workbook</span>
<span class="kn">import</span> <span class="nn">stingray.sheet</span>
<span class="kn">import</span> <span class="nn">stingray.schema</span>

<span class="n">logger</span><span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span> <span class="vm">__name__</span> <span class="p">)</span>
</pre></div>
</div>
<div class="section" id="orm-layer">
<h3>12.2.3.1. ORM Layer<a class="headerlink" href="#orm-layer" title="Permalink to this headline">¶</a></h3>
<p>We’ll often have an Object-Relational Mapping (ORM) layer.
These are components that are widely shared.  They could be SQLAlchemy
mapped class or a Django ORM class.</p>
<p>It’s appropriate to supplement the ORM with a “Form” that
follows the Django design pattern. This is a class that is used for validating
and creating model instances.</p>
<p>Here’s our fake model object, <code class="xref py py-class docutils literal notranslate"><span class="pre">This</span></code>, and it’s form, <code class="xref py py-class docutils literal notranslate"><span class="pre">ThisForm</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">This</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">pass</span> <span class="c1"># The ORM save operation</span>

<span class="k">class</span> <span class="nc">ThisForm</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="o">=</span> <span class="n">kw</span>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="n">This</span><span class="p">(</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">clean</span> <span class="p">)</span>
</pre></div>
</div>
<p>We need to be sure that the ORM’s save operation is only invoked through our persistence
processing <strong>Strategy</strong> object.  With some libraries the persistence can
be implicit, making it difficult to assure that persistence is disabled properly.</p>
<p>There are a number of ways to handle implicit persistence in ORM layers.
It may be necessary to provide a mock database “engine” or interface
in order to disable persistence.</p>
</div>
<div class="section" id="id1">
<h3>12.2.3.2. Persistence Context Manager<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>These two classes define our two modes: validation and normal operations.
The superclass defines the normal processing mode: we actually save objects.
The subclass defines validation-only mode: we don’t save anything.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Persistent_Processing</span><span class="p">:</span>
    <span class="n">stop_on_exception</span><span class="o">=</span> <span class="kc">True</span>
    <span class="k">def</span> <span class="nf">save_this</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">this_instance</span> <span class="p">):</span>
        <span class="n">this_instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

<span class="k">class</span> <span class="nc">Validate_Only_Processing</span><span class="p">(</span> <span class="n">Persistent_Processing</span> <span class="p">):</span>
    <span class="n">stop_on_exception</span><span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="nf">save_this</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">this_instance</span> <span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>In larger and more sophisticated applications, there may be a much more
complex set of class definitions to enable or disable persistence.</p>
</div>
<div class="section" id="builder-functions">
<h3>12.2.3.3. Builder Functions<a class="headerlink" href="#builder-functions" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="../developer.html#developer"><span class="std std-ref">The Stingray Developer’s Guide</span></a> for background. We’re going to need a “builder function.”
This transforms the source row object into the target object or collection.</p>
<p>To handle variant logical layouts, a number of builder functions are provided
to map the logical schemata to a more standardized conceptual schema.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">builder_1</span><span class="p">(</span> <span class="n">row</span> <span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Column &quot;3&quot; - string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">value</span><span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Col 2.0 - float&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_float</span><span class="p">()</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">builder_2</span><span class="p">(</span> <span class="n">row</span> <span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Column 3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">value</span><span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Column 2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_float</span><span class="p">()</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Note that these builder functions are frequently added to. It’s rare to get these
down to a single version that always works.</p>
<p>Consequently, it’s important to always <strong>add</strong> new builder functions.  Logical layouts are a
moving target.  Old layouts don’t go away; making changes to a builder is a bad idea.</p>
<p>It helps to have a function like this to map argument values to a builder function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_builder</span><span class="p">(</span> <span class="n">args</span> <span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="n">builder_1</span><span class="p">,</span>
            <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="n">builder_2</span>
            <span class="p">}[</span><span class="n">args</span><span class="o">.</span><span class="n">layout</span><span class="p">]</span>
</pre></div>
</div>
<p>It can help to have a better naming convention that “_1” and “_2”.  In practice,
however, it’s sometimes hard to determine why a logical layout changed, making
it hard to assign a meaningful name to the layout.</p>
</div>
<div class="section" id="processing">
<h3>12.2.3.4. Processing<a class="headerlink" href="#processing" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="../developer.html#developer"><span class="std std-ref">The Stingray Developer’s Guide</span></a> for background. We’re going to need a “sheet process function.”
This transforms the source sheet into the target collection, usually an output file.</p>
<p>The <a class="reference internal" href="../developer.html#process_sheet" title="process_sheet"><code class="xref py py-func docutils literal notranslate"><span class="pre">process_sheet()</span></code></a> function is the heart of the application.
This handles all the rows present in a given sheet.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_sheet</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">persistence</span> <span class="p">):</span>
    <span class="n">counts</span><span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span> <span class="nb">int</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">sheet</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Empty sheet -- no embedded schema</span>
        <span class="k">return</span> <span class="n">counts</span>
    <span class="k">for</span> <span class="n">source_row</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">rows_as_dict_iter</span><span class="p">(</span><span class="n">sheet</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">row_dict</span><span class="o">=</span> <span class="n">builder</span><span class="p">(</span> <span class="n">source_row</span> <span class="p">)</span>
            <span class="n">f</span><span class="o">=</span> <span class="n">ThisForm</span><span class="p">(</span> <span class="o">**</span><span class="n">row_dict</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">this</span><span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">persistence</span><span class="o">.</span><span class="n">save_this</span><span class="p">(</span> <span class="n">this</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;rejected&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;invalid&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">persistence</span><span class="o">.</span><span class="n">stop_on_exception</span><span class="p">:</span> <span class="k">raise</span>
            <span class="n">summary</span><span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="n">summary</span> <span class="p">)</span>
            <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="n">summary</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">counts</span>
</pre></div>
</div>
<p>Some applications will have variant processing for workbooks that
contain different types of sheets.
This leads to different <code class="xref py py-func docutils literal notranslate"><span class="pre">process_this_sheet()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">process_that_sheet()</span></code> functions.
Each will follow the above template to process all rows of the sheet.</p>
</div>
<div class="section" id="high-level-interfaces">
<h3>12.2.3.5. High-Level Interfaces<a class="headerlink" href="#high-level-interfaces" title="Permalink to this headline">¶</a></h3>
<p>These are the functions that can be used for live-file unit testing
of the application as a whole. The <code class="xref py py-func docutils literal notranslate"><span class="pre">validate()</span></code> function
uses a context manager for validation only. The <code class="xref py py-func docutils literal notranslate"><span class="pre">process()</span></code> function
uses the other context manager to that actual work is performed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">builder</span> <span class="p">):</span>
    <span class="k">with</span> <span class="n">Validate_Only_Processing</span><span class="p">()</span> <span class="k">as</span> <span class="n">mode</span><span class="p">:</span>
        <span class="n">counts</span><span class="o">=</span> <span class="n">process_sheet</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">mode</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">counts</span>

<span class="k">def</span> <span class="nf">process</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">builder</span> <span class="p">):</span>
    <span class="k">with</span> <span class="n">Persistent_Processing</span><span class="p">()</span> <span class="k">as</span> <span class="n">mode</span><span class="p">:</span>
        <span class="n">counts</span><span class="o">=</span> <span class="n">process_sheet</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">mode</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">counts</span>
</pre></div>
</div>
<p>These higher-level functions share a common <a class="reference internal" href="../developer.html#process_workbook" title="process_workbook"><code class="xref py py-func docutils literal notranslate"><span class="pre">process_workbook()</span></code></a>
function that does the real work.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_workbook</span><span class="p">(</span> <span class="n">source</span><span class="p">,</span> <span class="n">sheet_func</span><span class="p">,</span> <span class="n">builder_func</span> <span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">sheets</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> :: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">input</span><span class="p">,</span> <span class="n">name</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">sheet</span><span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">sheet</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span>
            <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">EmbeddedSchemaSheet</span><span class="p">,</span>
            <span class="n">loader_class</span><span class="o">=</span><span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">HeadingRowSchemaLoader</span> <span class="p">)</span>
        <span class="n">counts</span><span class="o">=</span> <span class="n">sheet_func</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">builder_func</span> <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">counts</span><span class="p">))</span> <span class="p">)</span>
</pre></div>
</div>
<p>When we do live-file testing of a given file, we can do something like the following.
This uses <code class="xref py py-func docutils literal notranslate"><span class="pre">validate()</span></code> to assure that the file’s schema is correct.
See <a class="reference internal" href="data_quality.html#demo-sqa"><span class="std std-ref">Unit Level Validation for Application and Data</span></a> for more information.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">some_app</span> <span class="k">import</span> <span class="n">validate</span>
<span class="k">class</span> <span class="nc">Test_Some_File</span><span class="p">(</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span> <span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">workbook</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span> <span class="nb">input</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder_func</span><span class="o">=</span> <span class="n">builder_1</span>
    <span class="k">def</span> <span class="nf">test_should_process_sheet1</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">sheet</span><span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">sheet</span><span class="p">(</span> <span class="s2">&quot;Sheet1&quot;</span><span class="p">,</span>
            <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">EmbeddedSchemaSheet</span><span class="p">,</span>
            <span class="n">loader_class</span><span class="o">=</span><span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">HeadingRowSchemaLoader</span> <span class="p">)</span>
        <span class="n">counts</span><span class="o">=</span> <span class="n">validate</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder_func</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span> <span class="mi">12345</span><span class="p">,</span> <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-interface">
<h3>12.2.3.6. Command-Line Interface<a class="headerlink" href="#command-line-interface" title="Permalink to this headline">¶</a></h3>
<p>We have some standard arguments.
While we’d like to use “-v” for validate mode, this gets confused with setting the verbosity level.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span><span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--dry-run&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>  <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--layout&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;verbosity&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</pre></div>
</div>
<p>The overall main program looks something like this.  It handles a number of
common main-program issues.</p>
<ol class="arabic simple">
<li>Logging.</li>
<li>Parameter Parsing.  This includes interpreting options.</li>
<li>Argument Processing.  This means looping over the positional arguments.</li>
<li>Opening Workbooks.  Some applications can’t use the default
<code class="xref py py-class docutils literal notranslate"><span class="pre">workbook.Opener</span></code>.  A subclass of Opener, or more complex logic,
may be required.</li>
<li>Gracefully catching and logging exceptions.</li>
<li>Exit Status to the OS.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="p">)</span>
    <span class="n">args</span><span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="p">)</span>
    <span class="n">builder_func</span><span class="o">=</span> <span class="n">make_builder</span><span class="p">(</span> <span class="n">args</span> <span class="p">)</span>
    <span class="n">sheet_func</span><span class="o">=</span> <span class="n">validate</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span> <span class="k">else</span> <span class="n">process</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Mode: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">sheet_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">stingray</span><span class="o">.</span><span class="n">workbook</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span> <span class="nb">input</span> <span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">process_workbook</span><span class="p">(</span> <span class="n">source</span><span class="p">,</span> <span class="n">sheet_func</span><span class="p">,</span> <span class="n">builder_func</span> <span class="p">)</span>
        <span class="n">status</span><span class="o">=</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span> <span class="n">e</span> <span class="p">)</span>
        <span class="n">status</span><span class="o">=</span> <span class="mi">3</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span> <span class="n">status</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="running-the-demo">
<h2>12.2.4. Running the Demo<a class="headerlink" href="#running-the-demo" title="Permalink to this headline">¶</a></h2>
<p>We can run this program like this.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 demo/app.py -d -l <span class="m">1</span> sample/<span class="se">\*</span>.csv
</pre></div>
</div>
<p>This will apply builder with layout <code class="docutils literal notranslate"><span class="pre">1</span></code> against all of the <code class="file docutils literal notranslate"><span class="pre">sample/*.csv</span></code> files.</p>
<p>The output looks like this</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>INFO:demo/app.py:Mode: validate
INFO:demo/app.py:sample/csv_workbook.csv :: csv_workbook
INFO:demo/app.py:{&#39;input&#39;: 2, &#39;valid&#39;: 2}
INFO:demo/app.py:sample/simple.csv :: simple
ERROR:demo/app.py:KeyError &#39;Column &quot;3&quot; - string&#39;
ERROR:demo/app.py:KeyError &#39;Column &quot;3&quot; - string&#39;
ERROR:demo/app.py:KeyError &#39;Column &quot;3&quot; - string&#39;
ERROR:demo/app.py:KeyError &#39;Column &quot;3&quot; - string&#39;
ERROR:demo/app.py:KeyError &#39;Column &quot;3&quot; - string&#39;
ERROR:demo/app.py:KeyError &#39;Column &quot;3&quot; - string&#39;
ERROR:demo/app.py:KeyError &#39;Column &quot;3&quot; - string&#39;
INFO:demo/app.py:{&#39;KeyError \&#39;Column &quot;3&quot; - string\&#39;&#39;: 7, &#39;input&#39;: 7}
</pre></div>
</div>
<p>We can see that <code class="file docutils literal notranslate"><span class="pre">sample/csv_workbook.csv</span></code> has two valid rows.</p>
<p>We can see that <code class="file docutils literal notranslate"><span class="pre">sample/simple.csv</span></code> has seven rows, all of which are missing the required value.
If all the rows are wrong, the schema in the file
doesn’t match the schema required by the application.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/Stingray_belon1553_small.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Stingray Schema-Based File Reader, stingray</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design.html">2. Design Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../package.html">3. The <code class="docutils literal notranslate"><span class="pre">stingray</span></code> Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cell.html">4. Stingray Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sheet.html">5. Stingray Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schema.html">6. Stingray Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schema_loader.html">7. Stingray Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workbook/index.html">8. Workbook Package – Uniform Wrappers for Workbooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iwork13.html">9. The “Other” Modules: snappy and protobuf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cobol.html">10. The COBOL Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">11. The <strong>Stingray</strong> Developer’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">12. <strong>Stingray</strong> Demo Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../history.html">13. History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">14. Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build.html">15. Stingray Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">16. Stingray Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">17. Licensing</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">12. <strong>Stingray</strong> Demo Applications</a><ul>
      <li>Previous: <a href="data_quality.html" title="previous chapter">12.1. Unit Level Validation for Application and Data</a></li>
      <li>Next: <a href="profile.html" title="next chapter">12.3. Data Profiling Demonstration</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2013, S. Lott.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/demo/validation.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>