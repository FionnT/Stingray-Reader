
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>8.4.5. XLSX or XLSM Workbook &#8212; The Stingray Schema-Based File Reader</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8.4.6. ODS Workbook" href="ods.html" />
    <link rel="prev" title="8.4.4. XLS Workbook" href="xls.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="xlsx-or-xlsm-workbook">
<span id="workbook-xlsx"></span><h1>8.4.5. XLSX or XLSM Workbook<a class="headerlink" href="#xlsx-or-xlsm-workbook" title="Permalink to this headline">¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">as</span> <span class="nn">dom</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">stingray.workbook.base</span> <span class="k">import</span> <span class="n">Workbook</span>
<span class="kn">import</span> <span class="nn">stingray.sheet</span>
<span class="kn">import</span> <span class="nn">stingray.cell</span>
</pre></div>
</div>
<span class="target" id="module-workbook.xlsx"></span><dl class="class">
<dt id="workbook.xlsx.XLSX_Workbook">
<em class="property">class </em><code class="descclassname">workbook.xlsx.</code><code class="descname">XLSX_Workbook</code><a class="headerlink" href="#workbook.xlsx.XLSX_Workbook" title="Permalink to this definition">¶</a></dt>
<dd><p>Extract sheets, rows and cells from an XLSX format file.</p>
<p>We’re opening a ZIP archive and parsing the various XML documents
that we find therein.</p>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">ElementTree</span></code> incremental parser provides
parse “events” for specific tags, allowing for lower-memory parsing of
the sometimes large XML documents.</p>
<p>See <a class="reference external" href="http://effbot.org/zone/element-iterparse.htm">http://effbot.org/zone/element-iterparse.htm</a></p>
<p>The class as a whole defines some handy constants like XML namespaces
and a pattern for parsing Cell ID’s to separate the letters from the numbers.</p>
<p>In addition to the superclass attributes, some additional unique
attributes are introduced here.</p>
<dl class="attribute">
<dt id="workbook.xlsx.XLSX_Workbook.zip_archive">
<code class="descname">zip_archive</code><a class="headerlink" href="#workbook.xlsx.XLSX_Workbook.zip_archive" title="Permalink to this definition">¶</a></dt>
<dd><p>A zip archive for this file.</p>
</dd></dl>

<dl class="attribute">
<dt id="workbook.xlsx.XLSX_Workbook.strings_dict">
<code class="descname">strings_dict</code><a class="headerlink" href="#workbook.xlsx.XLSX_Workbook.strings_dict" title="Permalink to this definition">¶</a></dt>
<dd><p>The strings in this workbook</p>
</dd></dl>

</dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">XLSX_Workbook</span><span class="p">(</span> <span class="n">Workbook</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ECMA Standard XLSX or XLSM documents.</span>
<span class="sd">    Locate sheets and rows within a given sheet.</span>

<span class="sd">    See http://www.ecma-international.org/publications/standards/Ecma-376.htm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Relevant subset of namespaces used</span>
    <span class="n">XLSX_NS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;main&quot;</span><span class="p">:</span><span class="s2">&quot;http://schemas.openxmlformats.org/spreadsheetml/2006/main&quot;</span><span class="p">,</span>
    <span class="s2">&quot;r&quot;</span><span class="p">:</span><span class="s2">&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rel&quot;</span><span class="p">:</span><span class="s2">&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">cell_id_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="sa">r</span><span class="s2">&quot;(\D+)(\d+)&quot;</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>
<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object.  If omitted, the named file is opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span> <span class="n">file_object</span> <span class="ow">or</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare</span><span class="p">()</span>
</pre></div>
</div>
<p>The are two preparation steps required for reading these files.  First, the
sheets must be located.  This involves resolving internal rID numbers.
Second, the shared strings need to be loaded into memory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_locate_sheets</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_get_shared_strings</span><span class="p">()</span>
</pre></div>
</div>
<p>Locate all sheets involves building a <code class="xref py py-data docutils literal notranslate"><span class="pre">name_to_id</span></code> mapping and  and <code class="xref py py-data docutils literal notranslate"><span class="pre">id_to_member</span></code> mapping.  This allows is to map the
user-oriented name to an id and the id to the XLSX zipfile member.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_locate_sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locate the name to id mapping and the id to member mapping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1a. Open &quot;workbook.xml&quot; member.</span>
    <span class="n">workbook_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s2">&quot;xl/workbook.xml&quot;</span><span class="p">)</span>
    <span class="n">workbook_doc</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_zip</span><span class="p">)</span> <span class="p">)</span>
    <span class="c1"># 1b. Get a dict of sheet names and their rIdx values.</span>
    <span class="n">key_attr_id</span><span class="o">=</span> <span class="s1">&#39;name&#39;</span>
    <span class="n">val_attr_id</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="s1">&#39;id&#39;</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key_attr_id</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">val_attr_id</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">workbook_doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;*/main:sheet&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span> <span class="p">)</span>

    <span class="c1"># 2a. Open the &quot;_rels/workbook.xml.rels&quot; member</span>
    <span class="n">rels_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s2">&quot;xl/_rels/workbook.xml.rels&quot;</span><span class="p">)</span>
    <span class="n">rels_doc</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rels_zip</span><span class="p">)</span> <span class="p">)</span>
    <span class="c1"># 2b. Get a dict of rIdx to Target member name</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span> <span class="n">rels_doc</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">key_attr_id</span><span class="o">=</span> <span class="s1">&#39;Id&#39;</span>
    <span class="n">val_attr_id</span><span class="o">=</span> <span class="s1">&#39;Target&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">id_to_member</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span> <span class="n">r</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key_attr_id</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">val_attr_id</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rels_doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;rel:Relationship&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_member</span> <span class="p">)</span>
</pre></div>
</div>
<p>Get Shared Strings walks a fine line.  Ideally, we’d like to parse
the document and simply use <code class="docutils literal notranslate"><span class="pre">itertext</span></code> to gather all of the text
within a given string instance (<code class="samp docutils literal notranslate"><span class="pre">&lt;si&gt;</span></code>) tag.  <strong>However.</strong></p>
<p>In practice, these documents can be so huge that they don’t fit
in memory comfortably.  We rely on incremental parsing via the <code class="docutils literal notranslate"><span class="pre">iterparse</span></code> function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_shared_strings</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build ``strings_dict`` with all shared strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">count</span><span class="o">=</span> <span class="mi">0</span>
    <span class="n">text_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">],</span> <span class="s2">&quot;t&quot;</span> <span class="p">)</span>
    <span class="n">string_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">],</span> <span class="s2">&quot;si&quot;</span> <span class="p">)</span>
    <span class="c1"># 1. Open the &quot;xl/sharedStrings.xml&quot; member</span>
    <span class="n">sharedStrings_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s2">&quot;xl/sharedStrings.xml&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">sharedStrings_zip</span> <span class="p">),</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,)</span> <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">text_tag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="p">[</span> <span class="n">count</span> <span class="p">]</span><span class="o">+=</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span>
        <span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">string_tag</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">element</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span> <span class="p">)</span>
</pre></div>
</div>
<p>The shared strings may be too massive for in-memory incremental parsing.
We can create a temporary extract file to handle this case. Here’s
the kind of code we might use.</p>
<pre class="literal-block">
with tempfile.TemporaryFile( ) as temp:
    self.zip_archive.extract( sharedStrings_mbr, temp.filename )
    for event, element in dom.iterparse( temp.filename ):
        <em>process event and element</em>
</pre>
<dl class="method">
<dt id="workbook.xlsx.XLSX_Workbook.sheets">
<code class="descclassname">XLSX_Workbook.</code><code class="descname">sheets</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#workbook.xlsx.XLSX_Workbook.sheets" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the list of sheets for this workbook.</p>
</dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
<p>Translate a col-row pair from <code class="samp docutils literal notranslate"><span class="pre">(</span><em><span class="pre">letter</span></em><span class="pre">,</span> <em><span class="pre">number</span></em><span class="pre">)</span></code>
to proper 0-based Python index of <code class="samp docutils literal notranslate"><span class="pre">(</span><em><span class="pre">row</span></em><span class="pre">,</span> <em><span class="pre">col</span></em><span class="pre">)</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">make_row_col</span><span class="p">(</span> <span class="n">col_row_pair</span> <span class="p">):</span>
    <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">col_row_pair</span>
    <span class="n">cn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">col_row_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">*</span><span class="mi">26</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="o">-</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="n">cn</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>We can build an eager <a class="reference internal" href="../sheet.html#sheet.Row" title="sheet.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">sheet.Row</span></code></a> or a  <a class="reference internal" href="../sheet.html#sheet.LazyRow" title="sheet.LazyRow"><code class="xref py py-class docutils literal notranslate"><span class="pre">sheet.LazyRow</span></code></a> from the available data.
The eager <a class="reference internal" href="../sheet.html#sheet.Row" title="sheet.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">sheet.Row</span></code></a> is built from <a class="reference internal" href="../cell.html#cell.Cell" title="cell.Cell"><code class="xref py py-class docutils literal notranslate"><span class="pre">cell.Cell</span></code></a> objects.
The <a class="reference internal" href="../sheet.html#sheet.LazyRow" title="sheet.LazyRow"><code class="xref py py-class docutils literal notranslate"><span class="pre">sheet.LazyRow</span></code></a> delegates the creation
of <a class="reference internal" href="../cell.html#cell.Cell" title="cell.Cell"><code class="xref py py-class docutils literal notranslate"><span class="pre">cell.Cell</span></code></a> objects to <code class="xref py py-meth docutils literal notranslate"><span class="pre">Workbook.row_get()</span></code>.</p>
<p>This uses an incremental parser, also.  There are four kinds of tags that
have to be located.</p>
<ul class="simple">
<li><code class="samp docutils literal notranslate"><span class="pre">&lt;row&gt;</span><em><span class="pre">row</span></em><span class="pre">&lt;/row&gt;</span></code>, end event.  Finish (and yield) the row of cells.
Since XLSX is sparse, missing empty cells must be filled in.</li>
<li><code class="samp docutils literal notranslate"><span class="pre">&lt;c</span> <span class="pre">t=&quot;</span><em><span class="pre">type</span></em><span class="pre">&quot;</span> <span class="pre">r=&quot;</span><em><span class="pre">id</span></em><span class="pre">&quot;&gt;</span><em><span class="pre">cell</span></em><span class="pre">&lt;/c&gt;</span></code>.<ul>
<li>Start event for <code class="docutils literal notranslate"><span class="pre">c</span></code>.  Get the cell type and id.  Empty the value accumulator.</li>
<li>End event for <code class="docutils literal notranslate"><span class="pre">c</span></code>.  Save the accumulated value.  This allows the cell to have
mixed content model.</li>
</ul>
</li>
<li><code class="samp docutils literal notranslate"><span class="pre">&lt;v&gt;</span><em><span class="pre">value</span></em><span class="pre">&lt;/v&gt;</span></code>, end event. Use the <a class="reference internal" href="../cell.html#module-cell" title="cell"><code class="xref py py-meth docutils literal notranslate"><span class="pre">cell()</span></code></a> method to track down
enough information to build the Cell instance.</li>
</ul>
<dl class="method">
<dt id="workbook.xlsx.XLSX_Workbook.rows_of">
<code class="descclassname">XLSX_Workbook.</code><code class="descname">rows_of</code><span class="sig-paren">(</span><em>sheet</em><span class="sig-paren">)</span><a class="headerlink" href="#workbook.xlsx.XLSX_Workbook.rows_of" title="Permalink to this definition">¶</a></dt>
<dd><p>Iterate through rows of the given sheet.</p>
</dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rows_of</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator over rows as a list of Cells for a named worksheet.&quot;&quot;&quot;</span>
    <span class="c1"># 1. Map user name to member.</span>
    <span class="n">rId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span><span class="p">[</span><span class="n">sheet</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sheet_member_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_member</span><span class="p">[</span><span class="n">rId</span><span class="p">]</span>
    <span class="c1"># 2. Open member.</span>
    <span class="n">sheet_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s2">&quot;xl/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">sheet_member_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># 3. Assemble each row, allowing for missing cells.</span>
    <span class="n">row_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">],</span> <span class="s2">&quot;row&quot;</span><span class="p">)</span>
    <span class="n">cell_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">],</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>
    <span class="n">value_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">],</span> <span class="s2">&quot;v&quot;</span><span class="p">)</span>
    <span class="n">format_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">],</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sheet_zip</span><span class="p">),</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)</span> <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">==</span><span class="s1">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">row_tag</span><span class="p">:</span>
            <span class="c1"># End of row: fill in missing cells</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">data</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">yield</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span> <span class="n">sheet</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">=</span> <span class="p">{}</span>
            <span class="n">element</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s1">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">cell_tag</span><span class="p">:</span>
            <span class="c1"># End of cell: consolidate the final string</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_col</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s1">&#39;start&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">cell_tag</span><span class="p">:</span>
            <span class="c1"># Start of cell: collect a string in pieces.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
            <span class="n">id_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_row_col</span><span class="p">(</span> <span class="n">id_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s1">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">value_tag</span><span class="p">:</span>
            <span class="c1"># End of a value; what type was it?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span> <span class="n">element</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s1">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">format_tag</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># A format string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;Ignoring&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="p">)</span> <span class="c1"># Numerous bits of structure exposed.</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.xlsx.XLSX_Workbook.row_get">
<code class="descclassname">XLSX_Workbook.</code><code class="descname">row_get</code><span class="sig-paren">(</span><em>row</em>, <em>attribute</em><span class="sig-paren">)</span><a class="headerlink" href="#workbook.xlsx.XLSX_Workbook.row_get" title="Permalink to this definition">¶</a></dt>
<dd><p>Low-level get of a particular attribute from the given row.</p>
</dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">row_get</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">attribute</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Cell from the row&#39;s data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">position</span><span class="p">]</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.xlsx.XLSX_Workbook.cell">
<code class="descclassname">XLSX_Workbook.</code><code class="descname">cell</code><span class="sig-paren">(</span><em>row</em>, <em>element</em><span class="sig-paren">)</span><a class="headerlink" href="#workbook.xlsx.XLSX_Workbook.cell" title="Permalink to this definition">¶</a></dt>
<dd><p>Build a subclass of <a class="reference internal" href="../cell.html#cell.Cell" title="cell.Cell"><code class="xref py py-class docutils literal notranslate"><span class="pre">cell.Cell</span></code></a> from the current value tag content plus the
containing cell type information.</p>
</dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cell</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">element</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a proper :py:class:`cell.Cell` subclass from cell and value information.&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">NumberCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Shared String?</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">)],</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Inline String?</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Not a valid shared string identifier?</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">BooleanCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">FloatDateCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">ErrorCell</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># &#39;str&#39; (formula), &#39;inlineStr&#39; (string), &#39;e&#39; (error)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">))</span> <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/Stingray_belon1553_small.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Stingray Schema-Based File Reader, stingray</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design.html">2. Design Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../package.html">3. The <code class="docutils literal notranslate"><span class="pre">stingray</span></code> Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cell.html">4. Cell Module – Data Element Containers and Conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sheet.html">5. Sheet Module – Sheet and Row Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schema.html">6. Schema Package – Schema and Attribute Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schema_loader.html">7. Schema Loader Module – Load Embedded or External Schema</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">8. Workbook Package – Uniform Wrappers for Workbooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iwork13.html">9. The “Other” Modules: snappy and protobuf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cobol.html">10. The COBOL Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">11. The <strong>Stingray</strong> Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../demo/index.html">12. <strong>Stingray</strong> Demo Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../history.html">13. History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">14. Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build.html">15. Stingray Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">16. Installation via <code class="docutils literal notranslate"><span class="pre">setup.py</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">17. Licensing</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">8. Workbook Package – Uniform Wrappers for Workbooks</a><ul>
      <li>Previous: <a href="xls.html" title="previous chapter">8.4.4. XLS Workbook</a></li>
      <li>Next: <a href="ods.html" title="next chapter">8.4.6. ODS Workbook</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2013, S. Lott.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/workbook/xlsx.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>