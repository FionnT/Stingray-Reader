
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.2. Protobuf Module – Unpacking iWork 13 files. &#8212; The Stingray Schema-Based File Reader</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="10. The COBOL Package" href="cobol.html" />
    <link rel="prev" title="9.1. Snappy Module – Unpacking iWork 13 files." href="snappy.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="protobuf-module-unpacking-iwork-13-files">
<span id="protobuf"></span><h1>9.2. Protobuf Module – Unpacking iWork 13 files.<a class="headerlink" href="#protobuf-module-unpacking-iwork-13-files" title="Permalink to this headline">¶</a></h1>
<p>This is not a full implementation of Protobuf object representation.
This is a minimal implementation of protobuf parsing, enough to unpack iWork ‘13 files.</p>
<span class="target" id="module-protobuf"></span><div class="section" id="the-iwork-13-use-of-protobuf">
<h2>9.2.1. The iWork ‘13 use of protobuf<a class="headerlink" href="#the-iwork-13-use-of-protobuf" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/obriensp/iWorkFileFormat">https://github.com/obriensp/iWorkFileFormat</a></p>
<p><a class="reference external" href="https://github.com/obriensp/iWorkFileFormat/blob/master/Docs/index.md">https://github.com/obriensp/iWorkFileFormat/blob/master/Docs/index.md</a></p>
<blockquote>
<div><p>“Components are serialized into .iwa (iWork Archive) files,
a custom format consisting of a Protobuf stream wrapped in a Snappy stream.</p>
<p>“Protobuf</p>
<p>“The uncompresed IWA contains the Component’s objects, serialized consecutively
in a Protobuf stream. Each object begins with a varint representing the length of
the ArchiveInfo message, followed by the ArchiveInfo message itself.
The ArchiveInfo includes a variable number of MessageInfo messages describing
the encoded Payloads that follow, though in practice iWork files seem to only
have one payload message per ArchiveInfo.</p>
<p>“Payload</p>
<p>“The format of the payload is determined by the type field of the associated
MessageInfo message. The iWork applications manually map these integer values
to their respective Protobuf message types, and the mappings vary slightly
between Keynote, Pages and Numbers. This information can be recovered by
inspecting the TSPRegistry class at runtime.</p>
<p>“TSPRegistry”</p>
<p>“The mapping between an object’s MessageInfo.type and its respective Protobuf
message type must by extracted from the iWork applications at runtime.
Attaching to Keynote via a debugger and inspecting [TSPRegistry sharedRegistry] shows:</p>
<p>“A full list of the type mappings can be found here.”</p>
<p><a class="reference external" href="https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Persistence/MessageTypes">https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Persistence/MessageTypes</a></p>
</div></blockquote>
<p>Message <code class="docutils literal notranslate"><span class="pre">.proto</span></code> files.</p>
<ul>
<li><p class="first">Table details</p>
<p><a class="reference external" href="https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Messages/Proto/TSTArchives.proto">https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Messages/Proto/TSTArchives.proto</a></p>
</li>
<li><p class="first">Numbers details</p>
<p><a class="reference external" href="https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Messages/Proto/TNArchives.proto">https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Messages/Proto/TNArchives.proto</a></p>
</li>
<li><p class="first">Calculating Engine details</p>
<p><a class="reference external" href="https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Messages/Proto/TSCEArchives.proto">https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Messages/Proto/TSCEArchives.proto</a></p>
</li>
<li><p class="first">Structure (i.e., TreeNode, perhaps more relevant for Keynote)</p>
<p><a class="reference external" href="https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Messages/Proto/TSKArchives.proto">https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Messages/Proto/TSKArchives.proto</a></p>
</li>
</ul>
<p>We require two of the files from this project to map the internal code numbers</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Persistence/MessageTypes/Numbers.json">https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Persistence/MessageTypes/Numbers.json</a></li>
<li><a class="reference external" href="https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Persistence/MessageTypes/Common.json">https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Persistence/MessageTypes/Common.json</a></li>
</ul>
<p>These files are incorporated into this module as separate <code class="file docutils literal notranslate"><span class="pre">*.json</span></code> files.
See <a class="reference internal" href="installation.html#installation"><span class="std std-ref">Installation via setup.py</span></a> for more information on these files.</p>
</div>
<div class="section" id="id1">
<h2>9.2.2. protobuf<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>For more information on protobuf, see the following:</p>
<p><a class="reference external" href="https://developers.google.com/protocol-buffers/">https://developers.google.com/protocol-buffers/</a></p>
<p><a class="reference external" href="https://developers.google.com/protocol-buffers/docs/encoding">https://developers.google.com/protocol-buffers/docs/encoding</a></p>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Protocol_Buffers">http://en.wikipedia.org/wiki/Protocol_Buffers</a></p>
</div>
<div class="section" id="iwa-structure">
<h2>9.2.3. IWA Structure<a class="headerlink" href="#iwa-structure" title="Permalink to this headline">¶</a></h2>
<p>Each IWA has an ArchiveInfo message.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="n">ArchiveInfo</span> <span class="p">{</span>
    <span class="n">optional</span> <span class="n">uint64</span> <span class="n">identifier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">repeated</span> <span class="n">MessageInfo</span> <span class="n">message_infos</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Within the ArchiveInfo is a MessageInfo message.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="n">MessageInfo</span> <span class="p">{</span>
    <span class="n">required</span> <span class="n">uint32</span> <span class="nb">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">repeated</span> <span class="n">uint32</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">[</span><span class="n">packed</span> <span class="o">=</span> <span class="n">true</span><span class="p">];</span>
    <span class="n">required</span> <span class="n">uint32</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">repeated</span> <span class="n">FieldInfo</span> <span class="n">field_infos</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">repeated</span> <span class="n">uint64</span> <span class="n">object_references</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">[</span><span class="n">packed</span> <span class="o">=</span> <span class="n">true</span><span class="p">];</span>
    <span class="n">repeated</span> <span class="n">uint64</span> <span class="n">data_references</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">[</span><span class="n">packed</span> <span class="o">=</span> <span class="n">true</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The MessageInfo is followed by the payload. That must be decoded to get the
actual data of interest.</p>
</div>
<div class="section" id="implementation">
<h2>9.2.4. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>Module docstring.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Read protobuf-serialized messages from IWA files used for Numbers &#39;13 workbooks.</span>

<span class="sd">https://developers.google.com/protocol-buffers/</span>

<span class="sd">https://developers.google.com/protocol-buffers/docs/encoding</span>

<span class="sd">Requires :file:`Numbers.json` and :file:`Common.json` from the installation</span>
<span class="sd">directory.</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Some Overheads</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">ChainMap</span>
<span class="kn">from</span> <span class="nn">stingray.snappy</span> <span class="k">import</span> <span class="n">varint</span>
</pre></div>
</div>
<dl class="class">
<dt id="protobuf.Message">
<em class="property">class </em><code class="descclassname">protobuf.</code><code class="descname">Message</code><a class="headerlink" href="#protobuf.Message" title="Permalink to this definition">¶</a></dt>
<dd><p>A definition of a generic protobuf message. This is both an instance
and it also has staticmethods that build instances from a buffer of bytes.</p>
<p>We don’t use subclasses of <code class="docutils literal notranslate"><span class="pre">Message</span></code>. The proper way to use
Protobuf is to compile <code class="docutils literal notranslate"><span class="pre">.proto</span></code> files into Message class definitions.</p>
</dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Message</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generic protobuf message built from sequence of bytes.</span>

<span class="sd">    :ivar name_: the protobuf message name.</span>
<span class="sd">    :ivar fields: a dict that maps field numbers to field values.</span>
<span class="sd">        The contained message objects are **not** parsed, but left as</span>
<span class="sd">        raw bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">bytes</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_</span><span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">parse_protobuf</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">(</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">index</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">,[])</span>
</pre></div>
</div>
<dl class="method">
<dt id="protobuf.Message.parse_protobuf_iter">
<code class="descclassname">Message.</code><code class="descname">parse_protobuf_iter</code><span class="sig-paren">(</span><em>message_bytes</em><span class="sig-paren">)</span><a class="headerlink" href="#protobuf.Message.parse_protobuf_iter" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterative parser for the top-level (name, value) pairs in the protobuf stream.
This yields all of the pairs that are parsed. This a static method which builds
message instances.</p>
</dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">parse_protobuf_iter</span><span class="p">(</span> <span class="n">message_bytes</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a protobuf stream, iterating over the name-value pairs that are present.</span>
<span class="sd">    This does NOT recursively descend through contained sub-messages.</span>
<span class="sd">    It does only the top-level message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bytes_iter</span><span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">message_bytes</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">item</span><span class="o">=</span> <span class="n">varint</span><span class="p">(</span> <span class="n">bytes_iter</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">item</span><span class="o">=</span> <span class="kc">None</span>
            <span class="k">break</span>
        <span class="n">field_number</span><span class="p">,</span> <span class="n">wire_type</span> <span class="o">=</span> <span class="n">item</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">item</span> <span class="o">&amp;</span> <span class="mb">0b111</span>
        <span class="k">if</span> <span class="n">wire_type</span> <span class="o">==</span> <span class="mb">0b000</span><span class="p">:</span>   <span class="c1"># varint representation</span>
            <span class="n">item_size</span><span class="o">=</span> <span class="kc">None</span> <span class="c1"># varint sizes vary, need something for debug message</span>
            <span class="n">field_value</span> <span class="o">=</span> <span class="n">varint</span><span class="p">(</span> <span class="n">bytes_iter</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">wire_type</span> <span class="o">==</span> <span class="mb">0b001</span><span class="p">:</span> <span class="c1"># 64-bit == 8-byte</span>
            <span class="n">item_size</span><span class="o">=</span> <span class="mi">8</span>
            <span class="n">field_value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="nb">next</span><span class="p">(</span><span class="n">bytes_iter</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">wire_type</span> <span class="o">==</span> <span class="mb">0b010</span><span class="p">:</span> <span class="c1"># varint length and then content</span>
            <span class="n">item_size</span><span class="o">=</span> <span class="n">varint</span><span class="p">(</span> <span class="n">bytes_iter</span> <span class="p">)</span>
            <span class="n">field_value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="nb">next</span><span class="p">(</span><span class="n">bytes_iter</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">item_size</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">wire_type</span> <span class="o">==</span> <span class="mb">0b101</span><span class="p">:</span> <span class="c1"># 32-byte == 4-byte</span>
            <span class="n">item_size</span><span class="o">=</span> <span class="mi">4</span>
            <span class="n">field_value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="nb">next</span><span class="p">(</span><span class="n">bytes_iter</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Unsupported </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">field_number</span><span class="p">,</span> <span class="n">wire_type</span> <span class="p">)</span>
        <span class="n">Message</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{0:b}</span><span class="s1">, field </span><span class="si">{1}</span><span class="s1">, type </span><span class="si">{2}</span><span class="s1">, size </span><span class="si">{3}</span><span class="s1">, = </span><span class="si">{4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">item</span><span class="p">,</span> <span class="n">field_number</span><span class="p">,</span> <span class="n">wire_type</span><span class="p">,</span> <span class="n">item_size</span><span class="p">,</span> <span class="n">field_value</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">yield</span> <span class="n">field_number</span><span class="p">,</span> <span class="n">field_value</span>
</pre></div>
</div>
<dl class="method">
<dt id="protobuf.Message.parse_protobuf">
<code class="descclassname">Message.</code><code class="descname">parse_protobuf</code><span class="sig-paren">(</span><em>message_bytes</em><span class="sig-paren">)</span><a class="headerlink" href="#protobuf.Message.parse_protobuf" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a bag in the form of a mapping <code class="docutils literal notranslate"><span class="pre">{name:</span> <span class="pre">[value,value,value],</span> <span class="pre">...</span> <span class="pre">}</span></code>. This will
contain the top-level identifiers and the bytes that could be used to parse
lower-level messages.</p>
</dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">parse_protobuf</span><span class="p">(</span> <span class="n">message_bytes</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a bag of name-value pairs. Names can repeat, so values are</span>
<span class="sd">    an ordered list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bag</span><span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span> <span class="nb">list</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">Message</span><span class="o">.</span><span class="n">parse_protobuf_iter</span><span class="p">(</span> <span class="n">message_bytes</span> <span class="p">):</span>
        <span class="n">bag</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">value</span> <span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bag</span><span class="p">)</span>
</pre></div>
</div>
<p>A class-level logger. We don’t want a logger for each instance, since we’ll
create many <code class="docutils literal notranslate"><span class="pre">Message</span></code> instances.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Message</span><span class="o">.</span><span class="n">log</span><span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span> <span class="n">Message</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="class">
<dt id="protobuf.Archive_Reader">
<em class="property">class </em><code class="descclassname">protobuf.</code><code class="descname">Archive_Reader</code><a class="headerlink" href="#protobuf.Archive_Reader" title="Permalink to this definition">¶</a></dt>
<dd><p>A Reader for IWA archives. This requires that the archive has been
processed by the <a class="reference internal" href="snappy.html#snappy.Snappy" title="snappy.Snappy"><code class="xref py py-class docutils literal notranslate"><span class="pre">snappy.Snappy</span></code></a> decompressor.</p>
</dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Archive_Reader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read and yield Archive entries from MessageInfo.type and payload.</span>
<span class="sd">    Resolves the ID into a protobuf message name.</span>

<span class="sd">    Mapping from types to messages</span>

<span class="sd">    -   https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Persistence/MessageTypes/Numbers.json</span>

<span class="sd">    -   https://github.com/obriensp/iWorkFileFormat/blob/master/iWorkFileInspector/iWorkFileInspector/Persistence/MessageTypes/Common.json</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsp_names</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsp_name_map</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="p">)</span>
</pre></div>
</div>
<p>Mapping from internal code numbers of protobuf message class names.
This requires <code class="file docutils literal notranslate"><span class="pre">Numbers.json</span></code> and <code class="file docutils literal notranslate"><span class="pre">Common.json</span></code> from the installation
directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">_tsp_name_map</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Build the TSPRegistry map from messageInfo.type to message proto</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">load_map</span><span class="p">(</span> <span class="n">filename</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;JSON documents have string keys: these must be converted to int.&quot;&quot;&quot;</span>
        <span class="n">installed</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">installed</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">raw</span><span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">source</span> <span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">)</span>

    <span class="n">tsp_names</span><span class="o">=</span> <span class="n">ChainMap</span><span class="p">(</span>
        <span class="n">load_map</span><span class="p">(</span><span class="s2">&quot;Numbers.json&quot;</span><span class="p">),</span>
        <span class="n">load_map</span><span class="p">(</span><span class="s2">&quot;Common.json&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">tsp_names</span>
</pre></div>
</div>
<dl class="method">
<dt id="protobuf.Archive_Reader.make_message">
<code class="descclassname">Archive_Reader.</code><code class="descname">make_message</code><span class="sig-paren">(</span><em>messageInfo</em>, <em>payload</em><span class="sig-paren">)</span><a class="headerlink" href="#protobuf.Archive_Reader.make_message" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Create the payload message from a MessageInfo instance and the payload bytes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_message</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">messageInfo</span><span class="p">,</span> <span class="n">payload</span> <span class="p">):</span>
    <span class="n">name</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsp_names</span><span class="p">[</span><span class="n">messageInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">Message</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">payload</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="protobuf.Archive_Reader.archive_iter">
<code class="descclassname">Archive_Reader.</code><code class="descname">archive_iter</code><span class="sig-paren">(</span><em>data</em><span class="sig-paren">)</span><a class="headerlink" href="#protobuf.Archive_Reader.archive_iter" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Iterate through all messages in this IWA archive. Locate the ArchiveInfo,
MessageInfo and Payload. Parse the payload to create the final message
that’s associated with the ID in the ArchiveInfo.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">archive_iter</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterate through the iWork protobuf-serialized archive:</span>
<span class="sd">    Locate the ArchiveInfo object.</span>
<span class="sd">    Each ArchiveInfo contains a MessageInfo(s).</span>
<span class="sd">    Each MessageInfo describes a payload.</span>
<span class="sd">    It appears that there&#39;s only one MessageInfo per ArchiveInfo</span>
<span class="sd">    even though the ``.proto`` file indicates multiple as possible.</span>

<span class="sd">    Yield a sequence of iWork archived messages as pairs:</span>
<span class="sd">        identifier, Message object built from the payload.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">protobuf</span><span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">size</span><span class="o">=</span> <span class="n">varint</span><span class="p">(</span> <span class="n">protobuf</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">size</span><span class="o">=</span> <span class="kc">None</span>
            <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> bytes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">message_bytes</span><span class="o">=</span> <span class="p">[</span> <span class="nb">next</span><span class="p">(</span><span class="n">protobuf</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">archiveInfo</span><span class="o">=</span> <span class="n">Message</span><span class="p">(</span> <span class="s2">&quot;ArchiveInfo&quot;</span><span class="p">,</span> <span class="n">message_bytes</span><span class="p">)</span>
        <span class="n">archiveInfo</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">archiveInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">archiveInfo</span><span class="o">.</span><span class="n">message_infos</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Message</span><span class="p">(</span><span class="s2">&quot;MessageInfo&quot;</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span> <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="n">archiveInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot; ArchiveInfo identifier=</span><span class="si">{0}</span><span class="s2"> message_infos=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">archiveInfo</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">archiveInfo</span><span class="o">.</span><span class="n">message_infos</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">messageInfo_0</span><span class="o">=</span> <span class="n">archiveInfo</span><span class="o">.</span><span class="n">message_infos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">messageInfo_0</span><span class="o">.</span><span class="n">length</span><span class="o">=</span> <span class="n">messageInfo_0</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;   MessageInfo length=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">messageInfo_0</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">payload_raw</span><span class="o">=</span> <span class="p">[</span> <span class="nb">next</span><span class="p">(</span><span class="n">protobuf</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">messageInfo_0</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;     Payload </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">payload_raw</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">message</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_message</span><span class="p">(</span> <span class="n">messageInfo_0</span><span class="p">,</span> <span class="n">payload_raw</span> <span class="p">)</span>
        <span class="k">yield</span> <span class="n">archiveInfo</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">message</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/Stingray_belon1553_small.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">The Stingray Schema-Based File Reader, stingray</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html">2. Design Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="package.html">3. The <code class="docutils literal notranslate"><span class="pre">stingray</span></code> Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="cell.html">4. Cell Module – Data Element Containers and Conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="sheet.html">5. Sheet Module – Sheet and Row Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema.html">6. Schema Package – Schema and Attribute Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema_loader.html">7. Schema Loader Module – Load Embedded or External Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="workbook/index.html">8. Workbook Package – Uniform Wrappers for Workbooks</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="iwork13.html">9. The “Other” Modules: snappy and protobuf</a></li>
<li class="toctree-l1"><a class="reference internal" href="cobol.html">10. The COBOL Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">11. The <strong>Stingray</strong> Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo/index.html">12. <strong>Stingray</strong> Demo Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">13. History</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing/index.html">14. Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="build.html">15. Stingray Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">16. Installation via <code class="docutils literal notranslate"><span class="pre">setup.py</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">17. Licensing</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="iwork13.html">9. The “Other” Modules: snappy and protobuf</a><ul>
      <li>Previous: <a href="snappy.html" title="previous chapter">9.1. Snappy Module – Unpacking iWork 13 files.</a></li>
      <li>Next: <a href="cobol.html" title="next chapter">10. The COBOL Package</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2013, S. Lott.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/protobuf.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>