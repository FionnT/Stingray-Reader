<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8. Workbook Module – Uniform Wrapper on All Workbooks &mdash; The Stingray Schema-Based File Reader</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4.4.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="The Stingray Schema-Based File Reader" href="index.html" />
    <link rel="next" title="9. The iWork ‘13 Numbers Modules" href="iwork13.html" />
    <link rel="prev" title="7. Schema Loader Module – Load Embedded or External Schema" href="schema_loader.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="iwork13.html" title="9. The iWork ‘13 Numbers Modules"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="schema_loader.html" title="7. Schema Loader Module – Load Embedded or External Schema"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">The Stingray Schema-Based File Reader</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-workbook">
<span id="workbook-module-uniform-wrapper-on-all-workbooks"></span><span id="workbook"></span><h1>8. Workbook Module &#8211; Uniform Wrapper on All Workbooks<a class="headerlink" href="#module-workbook" title="Permalink to this headline">¶</a></h1>
<p>A <em>Workbook</em> is a collection of <em>Sheets</em>.  It&#8217;s also a set of decoding
rules required to translate bytes (or XML text) into meaningful <em>Cell</em> instances.</p>
<p>Access to cells of a Workbook requires two levels of schema:</p>
<ul class="simple">
<li><em>Physical Format</em>.  The format required to locate cells.
CSV, XLS, XLSX, ODS, are all well-known physical formats and the physical
schema is implied by the file type.
Fixed format and COBOL format, are not well-known, and a physical
schema is required.</li>
<li><em>Logical Layout</em>. The columns or data elements present in the file.
This may depend on an embedded schema in the first rows of a Sheet.
Or it may depend on an external schema defined in another Workbook.</li>
</ul>
<p>This package addresses the physical format issues. It provides a common
abstraction over a number of forms of workbook data.  It makes the physical
format largely transparent to an application.</p>
<p>It&#8217;s difficult to make the logical layout transparent.
See <a class="reference internal" href="developer.html#developer"><em>The Stingray Developer&#8217;s Guide</em></a> for guidelines on developing applications that
are flexible with respect to logical layout.</p>
<p>In a way, a Workbook is a factory for <a class="reference internal" href="sheet.html#sheet.Sheet" title="sheet.Sheet"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Sheet</span></tt></a> and
<a class="reference internal" href="sheet.html#sheet.Row" title="sheet.Row"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Row</span></tt></a> objects.</p>
<p>More interestingly, a Workbook is a factory for <a class="reference internal" href="cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> instances.
This is because the decoding of bytes to create a cell is entirely a feature
of the Workbook.</p>
<div class="section" id="use-case">
<h2>8.1. Use Case<a class="headerlink" href="#use-case" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference internal" href="introduction.html#intro"><em>Introduction</em></a> for our physical-format independence use case.
A <a class="reference internal" href="#workbook.open_workbook" title="workbook.open_workbook"><tt class="xref py py-func docutils literal"><span class="pre">workbook.open_workbook()</span></tt></a> function allows a program to be
independent of physical format.</p>
<pre class="literal-block">
def process_workbook( input ):
    with workbook.open_workbook( input ) as source:
        process_workbook( source );

if __name__ == &quot;__main__&quot;:
    <em>application startup</em>
    for input in args.file:
        process_workbook( input )
</pre>
<p>This does not address logical layout issues, however, which are handled by a
<a class="reference internal" href="schema.html#schema.Schema" title="schema.Schema"><tt class="xref py py-class docutils literal"><span class="pre">schema.Schema</span></tt></a>.  We might load an embedded schema or an external schema.</p>
<pre class="literal-block">
def process_sheet( sheet ):
    &quot;&quot;&quot;Separated to facilitate unit testing&quot;&quot;&quot;
    counts= defaultdict( int )
    for rows in sheet.rows():
        <em>process row</em>
    return counts

def process_workbook( source ):
    for name in source.sheets():
        sheet= source.sheet( name,
            sheet.EmbeddedSchemaSheet,
            loader_class=schema.loader.HeadingRowSchemaLoader )
        counts= process_sheet( sheet )
        pprint.pprint( counts )
</pre>
</div>
<div class="section" id="physical-formats">
<h2>8.2. Physical Formats<a class="headerlink" href="#physical-formats" title="Permalink to this headline">¶</a></h2>
<p>Much data is transferred via formats
tied to desktop spreadsheet software or
informed by legacy mainframe design patterns.
Data that comes from spreadsheet applications
will have all the rich variety of desktop tools.</p>
<ul class="simple">
<li>CSV.  This includes the &#8220;quote-comma&#8221; dialetcs as used by spreadsheets
as well as &#8220;tab&#8221; or &#8220;pipe&#8221; dialetcs favored by Linux applications.</li>
<li>ODS.  This is a zipped archive of XML documents from which data can be extracted.
This is an ECMA standard.  This is the Open Office Spreadsheet structure.
Most of the relevant data is in a content.xml member.</li>
<li>XLSX or XLSM.  This is a zipped archive of XML documents from which data can be extracted.
This is an ECMA standard.</li>
<li>XLS.  This is the proprietary &#8220;Horrible Spreadsheet Format&#8221; (HSSF) as used by
Microsoft products.
We require <a class="reference external" href="http://www.lexicon.net/sjmachin/xlrd.htm">xlrd</a> to extract data from these files.</li>
<li>Apple iWorks &#8216;09 Numbers formats.
The iWorks &#8216;09 physical format is a simple ZipFile with a big XML document.</li>
<li>Apple iWorks &#8216;13 Numbers formats.
iWorks &#8216;13 physical format is the &#8220;bundle&#8221; or &#8220;package&#8221; format; the document
is a directory, which contains a zip archive of .IWA files. These use snappy
compression and protobuf object representation.</li>
<li>Fixed Format, COBOL-style.  Yes, these files still exist.  For
these files, schema information is <em>required</em> to determine where
the fields are, since there&#8217;s no puctuation. We can convert EBCDIC bytes or work
in Unicode-compatible text. ASCII encoding is usually handled trivially by
Python&#8217;s <tt class="docutils literal"><span class="pre">io</span></tt> module.</li>
<li>Other XML. For example, an Omni Outliner outlines with a normalized format.
This is a possible future direction.</li>
</ul>
<p>We&#8217;ll call <tt class="docutils literal"><span class="pre">CSV</span></tt>, <tt class="docutils literal"><span class="pre">XLS</span></tt>, <tt class="docutils literal"><span class="pre">XLSX</span></tt> / <tt class="docutils literal"><span class="pre">XLSM</span></tt> and <tt class="docutils literal"><span class="pre">ODS</span></tt>
the &#8220;well-known physical formats.&#8221;
They don&#8217;t require physical schema information in order
to identify the data items.</p>
<p>The Fixed and COBOL format files, on the other hand, require physical schema information.
We&#8217;ll look at COBOL in depth, in <a class="reference internal" href="cobol.html#cobol"><em>The COBOL Package</em></a>.</p>
</div>
<div class="section" id="model">
<h2>8.3. Model<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none"><div class="highlight"><pre>http://yuml.me/diagram/scruffy;/class/
#workbook,
[Workbook]^[CSV_Workbook],
[Workbook]^[XLS_Workbook],
[Workbook]^[XLSX_Workbook],
[Workbook]^[Fixed_Workbook],
[Workbook]^[ODS_Workbook],
[Workbook]&lt;&gt;-[Sheet],
[Sheet]&lt;&gt;-[Row],
[Workbook]-&gt;[Schema].
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/workbook.png"><img alt="_images/workbook.png" src="_images/workbook.png" style="width: 6in;" /></a>
</div>
<div class="section" id="implementation-overheads">
<h2>8.4. Implementation Overheads<a class="headerlink" href="#implementation-overheads" title="Permalink to this headline">¶</a></h2>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p>Refactor workbook package</p>
<p>This module needs to be rebuilt into a package which
imports a number of subsidiary modules. It&#8217;s too large
as written.</p>
<p>Adding Numbers &#8216;13 will make it even more monstrous.</p>
<p>It should become (like <a class="reference internal" href="cobol_init.html#module-cobol" title="cobol"><tt class="xref py py-mod docutils literal"><span class="pre">cobol</span></tt></a>) a high-level package
that imports top-level classes from modules within the package.</p>
<blockquote>
<div><p><tt class="docutils literal"><span class="pre">from</span> <span class="pre">workbook.csv</span> <span class="pre">import</span> <span class="pre">CSV_Workbook</span></tt></p>
<p><tt class="docutils literal"><span class="pre">from</span> <span class="pre">workbook.xls</span> <span class="pre">import</span> <span class="pre">XLS_Workbook</span></tt></p>
<p>... <em>etc.</em> ...</p>
</div></blockquote>
<p>This should make a transparent change from module to package.</p>
<p class="last">The top-level definition for <tt class="xref py py-class docutils literal"><span class="pre">cobol.Workbook</span></tt> must
to be refactored into a &#8220;defs&#8221; module that can be shared by
all the modules in the package.</p>
</div>
<p>A few Python overheads that must be physically first in the
resulting module.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;stingray.workbook -- Opens workbooks in various</span>
<span class="sd">formats, binds their associated schema, accesses them as Sheets with</span>
<span class="sd">Rows and Cells.</span>

<span class="sd">This is a kind of **Wrapper** or **Facade** that unifies :py:mod:`csv` and</span>
<span class="sd">:py:mod:`xlrd`. It handles a number of file formats including</span>
<span class="sd">:file:`.xlsx`, :file:`.ods`, and Numbers.</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>We depend on the following</p>
<p><tt class="docutils literal"><span class="pre">xlrd</span></tt>    <a class="reference external" href="https://pypi.python.org/pypi/xlrd/0.9.2">https://pypi.python.org/pypi/xlrd/0.9.2</a> <a class="reference external" href="http://www.lexicon.net/sjmachin/xlrd.htm">http://www.lexicon.net/sjmachin/xlrd.htm</a></p>
<p>We&#8217;ll rely on definitions of <a class="reference internal" href="cell.html#module-cell" title="cell"><tt class="xref py py-mod docutils literal"><span class="pre">cell</span></tt></a>, <a class="reference internal" href="sheet.html#module-sheet" title="sheet"><tt class="xref py py-mod docutils literal"><span class="pre">sheet</span></tt></a>,
and <a class="reference internal" href="schema_loader.html#module-schema.loader" title="schema.loader"><tt class="xref py py-mod docutils literal"><span class="pre">schema.loader</span></tt></a>. We have an implicit dependency on <a class="reference internal" href="schema.html#module-schema" title="schema"><tt class="xref py py-mod docutils literal"><span class="pre">schema</span></tt></a>:
we&#8217;ll be given schema objects to work with.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">xlrd</span>

<span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="kn">as</span> <span class="nn">dom</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="nb">open</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">decimal</span>

<span class="kn">import</span> <span class="nn">stingray.cell</span>
<span class="kn">import</span> <span class="nn">stingray.sheet</span>
<span class="kn">import</span> <span class="nn">stingray.schema.loader</span>
</pre></div>
</div>
</div>
<div class="section" id="workbook-structure">
<h2>8.5. Workbook Structure<a class="headerlink" href="#workbook-structure" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="workbook.Workbook">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">Workbook</tt><a class="headerlink" href="#workbook.Workbook" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>We note that these physical formats all encode a single, common data structure.
Here are some abstract definitions.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Workbook</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A workbook file; a collection of Sheets.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>

<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object.  If omitted, the named file is opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_file</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Any internal files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datemode</span><span class="o">=</span> <span class="mi">0</span> <span class="c"># For xlrd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__qualname__</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;{0}({1!r})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__qualname__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.Workbook.sheet">
<tt class="descclassname">Workbook.</tt><tt class="descname">sheet</tt><big>(</big><em>sheet_name</em>, <em>sheet_type</em>, <em>*args</em>, <em>**kw</em><big>)</big><a class="headerlink" href="#workbook.Workbook.sheet" title="Permalink to this definition">¶</a></dt>
<dd><p>There are two varieties of sheets, depending on the presence or
absence of a schema.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sheet</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">sheet_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a :py:class:`sheet.Sheet`, ready for processing.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sheet_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">sheet_type</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">Sheet</span>
    <span class="n">sheet</span> <span class="o">=</span> <span class="n">sheet_type</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">sheet</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.Workbook.sheets">
<tt class="descclassname">Workbook.</tt><tt class="descname">sheets</tt><big>(</big><big>)</big><a class="headerlink" href="#workbook.Workbook.sheets" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List of sheet names.</span>
<span class="sd">    The filename is a handy default for CSV and Fixed files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">nm</span> <span class="p">]</span>
</pre></div>
</div>
<p>The Context Manager interface.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
<span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">the_file</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.Workbook.rows_of">
<tt class="descclassname">Workbook.</tt><tt class="descname">rows_of</tt><big>(</big><em>sheet</em><big>)</big><a class="headerlink" href="#workbook.Workbook.rows_of" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">rows_of</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An iterator over all rows of the given sheet.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.Workbook.row_get">
<tt class="descclassname">Workbook.</tt><tt class="descname">row_get</tt><big>(</big><em>row</em>, <em>attribute</em><big>)</big><a class="headerlink" href="#workbook.Workbook.row_get" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">row_get</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">attribute</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Cell from the row&#39;s data.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>
</div>
<p>There are distinct subclasses of <a class="reference internal" href="#workbook.Workbook" title="workbook.Workbook"><tt class="xref py py-class docutils literal"><span class="pre">workbook.Workbook</span></tt></a>, based on the
physical file format.</p>
<p>Many of our physical formats don&#8217;t require any physical schema information.
A <strong>Fixed</strong> file, however, requires
a physical format schema definition in order to decompose
each line into cells.</p>
</div>
<div class="section" id="workbook-subclasses">
<h2>8.6. Workbook Subclasses<a class="headerlink" href="#workbook-subclasses" title="Permalink to this headline">¶</a></h2>
<p>We have a number of concrete subclasses of <a class="reference internal" href="#workbook.Workbook" title="workbook.Workbook"><tt class="xref py py-class docutils literal"><span class="pre">workbook.Workbook</span></tt></a>.</p>
<ul class="simple">
<li><a class="reference internal" href="#workbook.CSV_Workbook" title="workbook.CSV_Workbook"><tt class="xref py py-class docutils literal"><span class="pre">workbook.CSV_Workbook</span></tt></a>.  This is a degenerate case, where the workbook appears to contain
a single sheet.  This sheet is the CSV file, accessed via the built-in
<tt class="xref py py-func docutils literal"><span class="pre">csv.reader()</span></tt>.</li>
<li><a class="reference internal" href="#workbook.XLS_Workbook" title="workbook.XLS_Workbook"><tt class="xref py py-class docutils literal"><span class="pre">workbook.XLS_Workbook</span></tt></a>.  This is the workbook as processed by <tt class="xref py py-mod docutils literal"><span class="pre">xlrd</span></tt>.  These classes
wrap <tt class="xref py py-mod docutils literal"><span class="pre">xlrd</span></tt> classes to which the real work is delegated.</li>
<li><a class="reference internal" href="#workbook.XLSX_Workbook" title="workbook.XLSX_Workbook"><tt class="xref py py-class docutils literal"><span class="pre">workbook.XLSX_Workbook</span></tt></a>.  This is the workbook after unzipping and using an XML parser
on the various document parts.  Mostly, this is a matter of unzipping
and parsing parts of the document to create a DOM which can be traversed
as needed.</li>
<li><a class="reference internal" href="#workbook.Fixed_Workbook" title="workbook.Fixed_Workbook"><tt class="xref py py-class docutils literal"><span class="pre">workbook.Fixed_Workbook</span></tt></a>.  This is actually a fairly complex case.  The workbook will appear to
contain a single sheet; this sheet is the fixed format file.  Schema information
was required up front, unlike the other formats.</li>
<li><a class="reference internal" href="#workbook.Numbers09_Workbook" title="workbook.Numbers09_Workbook"><tt class="xref py py-class docutils literal"><span class="pre">workbook.Numbers09_Workbook</span></tt></a>.
This handles the iWork &#8216;09 Numbers files with multiple
workspaces and multiple tables in each workspace.</li>
<li><a class="reference internal" href="#workbook.Numbers13_Workbook" title="workbook.Numbers13_Workbook"><tt class="xref py py-class docutils literal"><span class="pre">workbook.Numbers13_Workbook</span></tt></a>
These handle the iWork &#8216;13 Numbers files with multiple
workspaces and multiple tables in each workspace.</li>
<li><a class="reference internal" href="#workbook.ODS_Workbook" title="workbook.ODS_Workbook"><tt class="xref py py-class docutils literal"><span class="pre">workbook.ODS_Workbook</span></tt></a>.</li>
</ul>
<p>Extensions will handle various kinds of COBOL files. They&#8217;re sumular to Fixed Workbooks.</p>
<p>We&#8217;d each of these to be a context manager, so we include
the necessary methods.</p>
<p>Note that workbooks are rarely simple files.  Sometimes they are ZIP archive
members.  Sometimes, they must be processed through gzip. Sometimes they involve
Snappy compression.</p>
<p>In order to minimize the assumptions, we try to handle two forms of file processing:</p>
<ul class="simple">
<li>By name. In this case, the file name is provided. The file is opened and closed by
the Workbook using the context manager interface.</li>
<li>By file-like object. An open file-like object is provided. No additional
context management is performed. This is appropriate when a workbook is itself
a member of a larger archive.</li>
</ul>
<div class="section" id="csv-workbook">
<h3>8.6.1. CSV Workbook<a class="headerlink" href="#csv-workbook" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="workbook.CSV_Workbook">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">CSV_Workbook</tt><a class="headerlink" href="#workbook.CSV_Workbook" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>We&#8217;re wrapping the <tt class="xref py py-func docutils literal"><span class="pre">csv.reader()</span></tt>.  We need to create proper
<a class="reference internal" href="cell.html#cell.TextCell" title="cell.TextCell"><tt class="xref py py-class docutils literal"><span class="pre">cell.TextCell</span></tt></a> instances instead of the default string values
that <tt class="xref py py-mod docutils literal"><span class="pre">csv</span></tt> normally creates.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CSV_Workbook</span><span class="p">(</span> <span class="n">Workbook</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses ``csv.reader``.  There&#39;s one sheet only.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>
<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object.  If omitted, the named file is opened.</span>
<span class="sd">            If provided, it must be opened with  newline=&#39;&#39; to permit non-standard</span>
<span class="sd">            line-endings.</span>

<span class="sd">        The kw are passed to :py:func:`csv.reader`</span>
<span class="sd">        to provide dialect information.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">the_file</span><span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rdr</span><span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">the_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">&#39;&#39;</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rdr</span><span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">the_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">)</span>
</pre></div>
</div>
<p>We can build an eager <a class="reference internal" href="sheet.html#sheet.Row" title="sheet.Row"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Row</span></tt></a> or a <a class="reference internal" href="sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> from
the available data.
The eager Row includes the conversions.  The <a class="reference internal" href="sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> defers
the conversions until the callback to <a class="reference internal" href="#workbook.Workbook.row_get" title="workbook.Workbook.row_get"><tt class="xref py py-meth docutils literal"><span class="pre">workbook.Workbook.row_get()</span></tt></a>.</p>
<dl class="method">
<dt id="workbook.CSV_Workbook.rows_of">
<tt class="descclassname">CSV_Workbook.</tt><tt class="descname">rows_of</tt><big>(</big><em>sheet</em><big>)</big><a class="headerlink" href="#workbook.CSV_Workbook.rows_of" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">rows_of</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An iterator over all rows of the named sheet.</span>
<span class="sd">    For CSV files, the sheet.name is simply ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdr</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">yield</span> <span class="n">row</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.CSV_Workbook.row_get">
<tt class="descclassname">CSV_Workbook.</tt><tt class="descname">row_get</tt><big>(</big><em>row</em>, <em>attribute</em><big>)</big><a class="headerlink" href="#workbook.CSV_Workbook.row_get" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">row_get</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">attribute</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Cell from the row&#39;s data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">position</span><span class="p">]</span>
</pre></div>
</div>
<p>Since <tt class="xref py py-mod docutils literal"><span class="pre">csv</span></tt> is eager, returning an individual <a class="reference internal" href="cell.html#cell.TextCell" title="cell.TextCell"><tt class="xref py py-class docutils literal"><span class="pre">cell.TextCell</span></tt></a>
is easy.</p>
</div>
<div class="section" id="xls-workbook">
<h3>8.6.2. XLS Workbook<a class="headerlink" href="#xls-workbook" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="workbook.XLS_Workbook">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">XLS_Workbook</tt><a class="headerlink" href="#workbook.XLS_Workbook" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>This definition of a workbook wraps <tt class="docutils literal"><span class="pre">xlrd</span></tt> so that it fits the Stingray framework.
We&#8217;ll use proper <a class="reference internal" href="cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> subclass instances instead of the default <tt class="docutils literal"><span class="pre">xlrd.Cell</span></tt>
values that <tt class="docutils literal"><span class="pre">xlrd</span></tt> normally creates.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">XLS_Workbook</span><span class="p">(</span> <span class="n">Workbook</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses ``xlrd``.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>
<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object.  If omitted, the named file is opened.</span>

<span class="sd">        The kw arguments are passed to :py:func:`xlrd.open_workbook`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file_contents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="o">**</span><span class="n">kw</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datemode</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">datemode</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.XLS_Workbook.sheets">
<tt class="descclassname">XLS_Workbook.</tt><tt class="descname">sheets</tt><big>(</big><big>)</big><a class="headerlink" href="#workbook.XLS_Workbook.sheets" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List of sheet names.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">sheet_names</span><span class="p">()</span>
</pre></div>
</div>
<p>We can build an eager <a class="reference internal" href="sheet.html#sheet.Row" title="sheet.Row"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Row</span></tt></a> or a <a class="reference internal" href="sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> from the available data.
The eager Row includes the conversions.  The LazyRow defers the conversions
until the callback to <a class="reference internal" href="#workbook.XLS_Workbook.row_get" title="workbook.XLS_Workbook.row_get"><tt class="xref py py-meth docutils literal"><span class="pre">XLS_Workbook.row_get()</span></tt></a>.</p>
<dl class="method">
<dt id="workbook.XLS_Workbook.rows_of">
<tt class="descclassname">XLS_Workbook.</tt><tt class="descname">rows_of</tt><big>(</big><em>sheet</em><big>)</big><a class="headerlink" href="#workbook.XLS_Workbook.rows_of" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">rows_of</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An iterator over all rows of the given sheet.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">sheet_by_name</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">nrows</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">yield</span> <span class="n">row</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.XLS_Workbook.row_get">
<tt class="descclassname">XLS_Workbook.</tt><tt class="descname">row_get</tt><big>(</big><em>row</em>, <em>attribute</em><big>)</big><a class="headerlink" href="#workbook.XLS_Workbook.row_get" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">row_get</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">attribute</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Cell from the row&#39;s data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">position</span><span class="p">]</span>
</pre></div>
</div>
<p>In <a class="reference internal" href="#workbook.XLS_Workbook.rows_of" title="workbook.XLS_Workbook.rows_of"><tt class="xref py py-meth docutils literal"><span class="pre">XLS_Workbook.rows_of()</span></tt></a> we built a row eagerly.
That way, returning an individual Cell is easy.</p>
<p>Convert a single <tt class="docutils literal"><span class="pre">xlrd.Cell</span></tt> to a proper subclass of <a class="reference internal" href="cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">cell</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">xlrd_cell</span> <span class="p">):</span>
    <span class="k">if</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_EMPTY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_TEXT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_NUMBER</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">NumberCell</span><span class="p">(</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_DATE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">FloatDateCell</span><span class="p">(</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_BOOLEAN</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">BooleanCell</span><span class="p">(</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_ERROR</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">ErrorCell</span><span class="p">(</span>
            <span class="n">xlrd</span><span class="o">.</span><span class="n">error_text_from_code</span><span class="p">[</span><span class="n">xlrd_cell</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">xlrd_cell</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_BLANK</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s">&quot;Damaged Workbook&quot;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="xlsx-or-xlsm-workbook">
<h3>8.6.3. XLSX or XLSM Workbook<a class="headerlink" href="#xlsx-or-xlsm-workbook" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="workbook.XLSX_Workbook">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">XLSX_Workbook</tt><a class="headerlink" href="#workbook.XLSX_Workbook" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>We&#8217;re opening a ZIP archive and parsing the various XML documents
that we find therein.</p>
<p>The <tt class="xref py py-class docutils literal"><span class="pre">ElementTree</span></tt> incremental parser provides
parse &#8220;events&#8221; for specific tags, allowing for lower-memory parsing of
the sometimes large XML documents.</p>
<p>See <a class="reference external" href="http://effbot.org/zone/element-iterparse.htm">http://effbot.org/zone/element-iterparse.htm</a></p>
<p>The class as a whole defines some handy constants like XML namespaces
and a pattern for parsing Cell ID&#8217;s to separate the letters from the numbers.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">XLSX_Workbook</span><span class="p">(</span> <span class="n">Workbook</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ECMA Standard XLSX or XLSM documents.</span>
<span class="sd">    Locate sheets and rows within a given sheet.</span>

<span class="sd">    See http://www.ecma-international.org/publications/standards/Ecma-376.htm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Relevant subset of namespaces used</span>
    <span class="n">XLSX_NS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;main&quot;</span><span class="p">:</span><span class="s">&quot;http://schemas.openxmlformats.org/spreadsheetml/2006/main&quot;</span><span class="p">,</span>
    <span class="s">&quot;r&quot;</span><span class="p">:</span><span class="s">&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships&quot;</span><span class="p">,</span>
    <span class="s">&quot;rel&quot;</span><span class="p">:</span><span class="s">&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">cell_id_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="s">r&quot;(\D+)(\d+)&quot;</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>
<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object.  If omitted, the named file is opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span> <span class="n">file_object</span> <span class="ow">or</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;r&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare</span><span class="p">()</span>
</pre></div>
</div>
<p>The are two preparation steps required for reading these files.  First, the
sheets must be located.  This involves resolving internal rID numbers.
Second, the shared strings need to be loaded into memory.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_locate_sheets</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_get_shared_strings</span><span class="p">()</span>
</pre></div>
</div>
<p>Locate all sheets involves building a <tt class="xref py py-data docutils literal"><span class="pre">name_to_id</span></tt> mapping and  and <tt class="xref py py-data docutils literal"><span class="pre">id_to_member</span></tt> mapping.  This allows is to map the
user-oriented name to an id and the id to the XLSX zipfile member.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_locate_sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locate the name to id mapping and the id to member mapping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># 1a. Open &quot;workbook.xml&quot; member.</span>
    <span class="n">workbook_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s">&quot;xl/workbook.xml&quot;</span><span class="p">)</span>
    <span class="n">workbook_doc</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_zip</span><span class="p">)</span> <span class="p">)</span>
    <span class="c"># 1b. Get a dict of sheet names and their rIdx values.</span>
    <span class="n">key_attr_id</span><span class="o">=</span> <span class="s">&#39;name&#39;</span>
    <span class="n">val_attr_id</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">],</span> <span class="s">&#39;id&#39;</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key_attr_id</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">val_attr_id</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">workbook_doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;*/main:sheet&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span> <span class="p">)</span>

    <span class="c"># 2a. Open the &quot;_rels/workbook.xml.rels&quot; member</span>
    <span class="n">rels_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s">&quot;xl/_rels/workbook.xml.rels&quot;</span><span class="p">)</span>
    <span class="n">rels_doc</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rels_zip</span><span class="p">)</span> <span class="p">)</span>
    <span class="c"># 2b. Get a dict of rIdx to Target member name</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span> <span class="n">rels_doc</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">key_attr_id</span><span class="o">=</span> <span class="s">&#39;Id&#39;</span>
    <span class="n">val_attr_id</span><span class="o">=</span> <span class="s">&#39;Target&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">id_to_member</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span> <span class="n">r</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key_attr_id</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">val_attr_id</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rels_doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;rel:Relationship&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_member</span> <span class="p">)</span>
</pre></div>
</div>
<p>Get Shared Strings walks a fine line.  Ideally, we&#8217;d like to parse
the document and simply use <tt class="docutils literal"><span class="pre">itertext</span></tt> to gather all of the text
within a given string instance (<tt class="samp docutils literal"><span class="pre">&lt;si&gt;</span></tt>) tag.  <strong>However.</strong></p>
<p>In practice, these documents can be so huge that they don&#8217;t fit
in memory comfortably.  We rely on incremental parsing via the <tt class="docutils literal"><span class="pre">iterparse</span></tt> function.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_shared_strings</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build ``strings_dict`` with all shared strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">count</span><span class="o">=</span> <span class="mi">0</span>
    <span class="n">text_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;t&quot;</span> <span class="p">)</span>
    <span class="n">string_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;si&quot;</span> <span class="p">)</span>
    <span class="c"># 1. Open the &quot;xl/sharedStrings.xml&quot; member</span>
    <span class="n">sharedStrings_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s">&quot;xl/sharedStrings.xml&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">sharedStrings_zip</span> <span class="p">),</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;end&#39;</span><span class="p">,)</span> <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">text_tag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="p">[</span> <span class="n">count</span> <span class="p">]</span><span class="o">+=</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span>
        <span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">string_tag</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">element</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span> <span class="p">)</span>
</pre></div>
</div>
<p>The shared strings may be too massive for in-memory incremental parsing.
We can create a temporary extract file to handle this case. Here&#8217;s
the kind of code we might use.</p>
<pre class="literal-block">
with tempfile.TemporaryFile( ) as temp:
    self.zip_archive.extract( sharedStrings_mbr, temp.filename )
    for event, element in dom.iterparse( temp.filename ):
        <em>process event and element</em>
</pre>
<dl class="method">
<dt id="workbook.XLSX_Workbook.sheets">
<tt class="descclassname">XLSX_Workbook.</tt><tt class="descname">sheets</tt><big>(</big><big>)</big><a class="headerlink" href="#workbook.XLSX_Workbook.sheets" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
<p>Translate a col-row pair from <tt class="samp docutils literal"><span class="pre">(</span><em><span class="pre">letter</span></em><span class="pre">,</span> <em><span class="pre">number</span></em><span class="pre">)</span></tt>
to proper 0-based Python index of <tt class="samp docutils literal"><span class="pre">(</span><em><span class="pre">row</span></em><span class="pre">,</span> <em><span class="pre">col</span></em><span class="pre">)</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">make_row_col</span><span class="p">(</span> <span class="n">col_row_pair</span> <span class="p">):</span>
    <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">col_row_pair</span>
    <span class="n">cn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">col_row_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">*</span><span class="mi">26</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="o">-</span><span class="nb">ord</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="n">cn</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>We can build an eager <a class="reference internal" href="sheet.html#sheet.Row" title="sheet.Row"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Row</span></tt></a> or a  <a class="reference internal" href="sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> from the available data.
The eager <a class="reference internal" href="sheet.html#sheet.Row" title="sheet.Row"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Row</span></tt></a> is built from <a class="reference internal" href="cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> objects.
The <a class="reference internal" href="sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> delegates the creation
of <a class="reference internal" href="cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> objects to <a class="reference internal" href="#workbook.Workbook.row_get" title="workbook.Workbook.row_get"><tt class="xref py py-meth docutils literal"><span class="pre">Workbook.row_get()</span></tt></a>.</p>
<p>This uses an incremental parser, also.  There are four kinds of tags that
have to be located.</p>
<ul class="simple">
<li><tt class="samp docutils literal"><span class="pre">&lt;row&gt;</span><em><span class="pre">row</span></em><span class="pre">&lt;/row&gt;</span></tt>, end event.  Finish (and yield) the row of cells.
Since XLSX is sparse, missing empty cells must be filled in.</li>
<li><tt class="samp docutils literal"><span class="pre">&lt;c</span> <span class="pre">t=&quot;</span><em><span class="pre">type</span></em><span class="pre">&quot;</span> <span class="pre">r=&quot;</span><em><span class="pre">id</span></em><span class="pre">&quot;&gt;</span><em><span class="pre">cell</span></em><span class="pre">&lt;/c&gt;</span></tt>.<ul>
<li>Start event for <tt class="docutils literal"><span class="pre">c</span></tt>.  Get the cell type and id.  Empty the value accumulator.</li>
<li>End event for <tt class="docutils literal"><span class="pre">c</span></tt>.  Save the accumulated value.  This allows the cell to have
mixed content model.</li>
</ul>
</li>
<li><tt class="samp docutils literal"><span class="pre">&lt;v&gt;</span><em><span class="pre">value</span></em><span class="pre">&lt;/v&gt;</span></tt>, end event. Use the <a class="reference internal" href="cell.html#module-cell" title="cell"><tt class="xref py py-meth docutils literal"><span class="pre">cell()</span></tt></a> method to track down
enough information to build the Cell instance.</li>
</ul>
<dl class="method">
<dt id="workbook.XLSX_Workbook.rows_of">
<tt class="descclassname">XLSX_Workbook.</tt><tt class="descname">rows_of</tt><big>(</big><em>sheet</em><big>)</big><a class="headerlink" href="#workbook.XLSX_Workbook.rows_of" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">rows_of</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator over rows as a list of Cells for a named worksheet.&quot;&quot;&quot;</span>
    <span class="c"># 1. Map user name to member.</span>
    <span class="n">rId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span><span class="p">[</span><span class="n">sheet</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sheet_member_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_member</span><span class="p">[</span><span class="n">rId</span><span class="p">]</span>
    <span class="c"># 2. Open member.</span>
    <span class="n">sheet_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s">&quot;xl/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">sheet_member_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">=</span> <span class="p">{}</span>
    <span class="c"># 3. Assemble each row, allowing for missing cells.</span>
    <span class="n">row_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;row&quot;</span><span class="p">)</span>
    <span class="n">cell_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;c&quot;</span><span class="p">)</span>
    <span class="n">value_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;v&quot;</span><span class="p">)</span>
    <span class="n">format_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;f&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sheet_zip</span><span class="p">),</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;start&#39;</span><span class="p">,</span><span class="s">&#39;end&#39;</span><span class="p">)</span> <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">row_tag</span><span class="p">:</span>
            <span class="c"># End of row: fill in missing cells</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">data</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">yield</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span> <span class="n">sheet</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">=</span> <span class="p">{}</span>
            <span class="n">element</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">cell_tag</span><span class="p">:</span>
            <span class="c"># End of cell: consolidate the final string</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_col</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;start&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">cell_tag</span><span class="p">:</span>
            <span class="c"># Start of cell: collect a string in pieces.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span>
            <span class="n">id_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_row_col</span><span class="p">(</span> <span class="n">id_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">value_tag</span><span class="p">:</span>
            <span class="c"># End of a value; what type was it?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span> <span class="n">element</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">format_tag</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># A format string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Ignoring&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">)</span> <span class="c"># Numerous bits of structure exposed.</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.XLSX_Workbook.row_get">
<tt class="descclassname">XLSX_Workbook.</tt><tt class="descname">row_get</tt><big>(</big><em>row</em>, <em>attribute</em><big>)</big><a class="headerlink" href="#workbook.XLSX_Workbook.row_get" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">row_get</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">attribute</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Cell from the row&#39;s data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">position</span><span class="p">]</span>
</pre></div>
</div>
<p>Build a subclass of <a class="reference internal" href="cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> from the current value tag content plus the
containing cell type information.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">cell</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">element</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a proper :py:class:`cell.Cell` subclass from cell and value information.&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">NumberCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&quot;s&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Shared String?</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">)],</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c"># Inline String?</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c"># Not a valid shared string identifier?</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&quot;b&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">BooleanCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&quot;d&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">FloatDateCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&quot;e&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">ErrorCell</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># &#39;str&#39; (formula), &#39;inlineStr&#39; (string), &#39;e&#39; (error)</span>
        <span class="k">print</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">))</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</div>
</div>
<div class="section" id="fixed-format-workbook">
<h3>8.6.4. Fixed-Format Workbook<a class="headerlink" href="#fixed-format-workbook" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="workbook.Fixed_Workbook">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">Fixed_Workbook</tt><a class="headerlink" href="#workbook.Fixed_Workbook" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Like a CSV workbook, this is a kind of degenerate case.  We don&#8217;t have
a lot of sheets, or a lot of data types.</p>
<p>A subclass might do EBCDIC conversion and possibly even decode
packed decimal numbers.  To do this, a COBOL-language DDE would be
required as the schema definition.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Fixed_Workbook</span><span class="p">(</span> <span class="n">Workbook</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A file with fixed-sized, no-punctuation fields.</span>

<span class="sd">    A schema is **required** to parse the attributes.</span>

<span class="sd">    The rows are defined as :py:class:`stingray.sheet.LazyRow` instances so that</span>
<span class="sd">    bad data can be gracefully skipped over.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">row_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">LazyRow</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>

<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object.  If omitted, the named file is opened.</span>
<span class="sd">        :param schema: Schema required for processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">the_file</span><span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">the_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="s">&#39;rt&#39;</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">the_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">=</span> <span class="n">schema</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.Fixed_Workbook.sheet">
<tt class="descclassname">Fixed_Workbook.</tt><tt class="descname">sheet</tt><big>(</big><em>sheet</em><big>)</big><a class="headerlink" href="#workbook.Fixed_Workbook.sheet" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sheet</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;sheet_type is ignored; it must be an external schema.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">ExternalSchemaSheet</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="p">)</span>
</pre></div>
</div>
<p>We can build eager <a class="reference internal" href="sheet.html#sheet.Row" title="sheet.Row"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Row</span></tt></a> instances for some
kinds of flat files.  Eager rows, however, don&#8217;t generalize well to COBOL structures.</p>
<p>Therefore, we must build  <a class="reference internal" href="sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> objects here and defer the
data type conversion until <a class="reference internal" href="#workbook.Fixed_Workbook.row_get" title="workbook.Fixed_Workbook.row_get"><tt class="xref py py-meth docutils literal"><span class="pre">workbook.Fixed_Workbook.row_get()</span></tt></a>.
Or <a class="reference internal" href="cobol_init.html#cobol.COBOL_File.row_get" title="cobol.COBOL_File.row_get"><tt class="xref py py-meth docutils literal"><span class="pre">cobol.COBOL_File.row_get()</span></tt></a>, which can be more complex still.</p>
<dl class="method">
<dt id="workbook.Fixed_Workbook.rows_of">
<tt class="descclassname">Fixed_Workbook.</tt><tt class="descname">rows_of</tt><big>(</big><em>sheet</em><big>)</big><a class="headerlink" href="#workbook.Fixed_Workbook.rows_of" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">rows_of</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An iterator over all rows of the named sheet.</span>
<span class="sd">    For Fixed files, the sheet.name is simply ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">=</span> <span class="n">sheet</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_class</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span> <span class="p">)</span>
        <span class="k">yield</span> <span class="n">row</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.Fixed_Workbook.row_get">
<tt class="descclassname">Fixed_Workbook.</tt><tt class="descname">row_get</tt><big>(</big><em>row</em>, <em>attribute</em><big>)</big><a class="headerlink" href="#workbook.Fixed_Workbook.row_get" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">row_get</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">attr</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a :py:class:`cell.Cell` from the row&#39;s data.&quot;&quot;&quot;</span>
    <span class="n">extract</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="n">attr</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span><span class="n">attr</span><span class="o">.</span><span class="n">offset</span><span class="o">+</span><span class="n">attr</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">create</span><span class="p">(</span> <span class="n">extract</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="bp">self</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ods-workbook">
<h3>8.6.5. ODS Workbook<a class="headerlink" href="#ods-workbook" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="workbook.ODS_Workbook">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">ODS_Workbook</tt><a class="headerlink" href="#workbook.ODS_Workbook" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>We should use <tt class="docutils literal"><span class="pre">iterparse</span></tt> rather than simply parsing the entire document.
If the document is large, then we can&#8217;t hold it all in memory.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ODS_Workbook</span><span class="p">(</span> <span class="n">Workbook</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Standard OOO ODS document.</span>
<span class="sd">    Locate sheets and rows within a given sheet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ODS_NS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;office&quot;</span><span class="p">:</span><span class="s">&quot;urn:oasis:names:tc:opendocument:xmlns:office:1.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;table&quot;</span><span class="p">:</span><span class="s">&quot;urn:oasis:names:tc:opendocument:xmlns:table:1.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;text&quot;</span><span class="p">:</span><span class="s">&quot;urn:oasis:names:tc:opendocument:xmlns:text:1.0&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">date_format</span> <span class="o">=</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>
<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object.  If omitted, the named file is opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span> <span class="n">file_object</span> <span class="ow">or</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;r&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare</span><span class="p">()</span>
</pre></div>
</div>
<p>As preparation for reading these files, we locate all the sheet names.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_locate_sheets</span><span class="p">()</span>
</pre></div>
</div>
<p>Locating all the sheets is a matter of doing an XPath search for
<tt class="samp docutils literal"><span class="pre">body/spreadsheet/table</span></tt> and getting the <em>name</em> attribute
from the  <tt class="samp docutils literal"><span class="pre">&lt;table</span> <span class="pre">name=&quot;</span><em><span class="pre">name</span></em><span class="pre">&quot;&gt;</span></tt> tags.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_locate_sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create ``tables`` map from name to table.&quot;&quot;&quot;</span>
    <span class="n">workbook_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s">&quot;content.xml&quot;</span><span class="p">)</span>
    <span class="n">workbook_doc</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_zip</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">name_attr_id</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ODS_NS</span><span class="p">[</span><span class="s">&quot;table&quot;</span><span class="p">],</span> <span class="s">&quot;name&quot;</span> <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span> <span class="n">workbook_doc</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">name_attr_id</span><span class="p">],</span><span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">workbook_doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;office:body/office:spreadsheet/table:table&quot;</span><span class="p">,</span>
            <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ODS_NS</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<p>An <tt class="docutils literal"><span class="pre">iterparse</span></tt> version to locate sheets
would look for start of <tt class="docutils literal"><span class="pre">table</span></tt> tags and then get
the name attribute from that tag.</p>
<dl class="method">
<dt id="workbook.ODS_Workbook.sheets">
<tt class="descclassname">ODS_Workbook.</tt><tt class="descname">sheets</tt><big>(</big><big>)</big><a class="headerlink" href="#workbook.ODS_Workbook.sheets" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
<p>We can build an eager <a class="reference internal" href="sheet.html#sheet.Row" title="sheet.Row"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Row</span></tt></a> or a <a class="reference internal" href="sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> from
the available data.  The eager Row includes the conversions.
The LazyRow defers the conversions to <a class="reference internal" href="#workbook.ODS_Workbook.row_get" title="workbook.ODS_Workbook.row_get"><tt class="xref py py-meth docutils literal"><span class="pre">ODS_Workbook.row_get()</span></tt></a>.</p>
<p>In ODS documents, the cell&#8217;s value can be carried in the value attribute or
it can be a mixed content value of the element.  There are three cases.</p>
<ul class="simple">
<li><tt class="samp docutils literal"><span class="pre">&lt;table-cell</span> <span class="pre">value-type=&quot;</span><em><span class="pre">type</span></em><span class="pre">&quot;</span> <span class="pre">value=&quot;</span><em><span class="pre">value</span></em><span class="pre">&quot;&gt;...&lt;/table-cell&gt;</span></tt></li>
<li><tt class="samp docutils literal"><span class="pre">&lt;table-cell</span> <span class="pre">value-type=&quot;</span><em><span class="pre">type</span></em><span class="pre">&quot;</span> <span class="pre">date-value=&quot;</span><em><span class="pre">value</span></em><span class="pre">&quot;&gt;...&lt;/table-cell&gt;</span></tt></li>
<li><tt class="samp docutils literal"><span class="pre">&lt;table-cell</span> <span class="pre">value-type=&quot;</span><em><span class="pre">type</span></em><span class="pre">&quot;&gt;</span><em><span class="pre">value</span></em><span class="pre">&lt;/table-cell&gt;</span></tt></li>
</ul>
<dl class="method">
<dt id="workbook.ODS_Workbook.rows_of">
<tt class="descclassname">ODS_Workbook.</tt><tt class="descname">rows_of</tt><big>(</big><big>)</big><a class="headerlink" href="#workbook.ODS_Workbook.rows_of" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">rows_of</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator over rows as a list of Cells for a named worksheet.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">row_doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">sheet</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span> <span class="s">&quot;table:table-row&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ODS_NS</span> <span class="p">)</span> <span class="p">):</span>
        <span class="n">row</span><span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">cell_doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">row_doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span> <span class="s">&quot;table:table-cell&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ODS_NS</span> <span class="p">)</span> <span class="p">):</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">cell_doc</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">yield</span> <span class="n">row</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.ODS_Workbook.row_get">
<tt class="descclassname">ODS_Workbook.</tt><tt class="descname">row_get</tt><big>(</big><em>row</em>, <em>attribute</em><big>)</big><a class="headerlink" href="#workbook.ODS_Workbook.row_get" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">row_get</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">attribute</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Cell from the row&#39;s data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">position</span><span class="p">]</span>
</pre></div>
</div>
<p>Build a subclass of <a class="reference internal" href="cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> from the current type name and value.</p>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">Refactor this, it feels clunky.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">cell</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cell_doc</span> <span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">cell_doc</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">value_attr_id</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ODS_NS</span><span class="p">[</span><span class="s">&#39;office&#39;</span><span class="p">],</span> <span class="s">&#39;value&#39;</span> <span class="p">)</span>
    <span class="n">date_attr_id</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ODS_NS</span><span class="p">[</span><span class="s">&#39;office&#39;</span><span class="p">],</span> <span class="s">&#39;date-value&#39;</span> <span class="p">)</span>
    <span class="n">type_attr_id</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ODS_NS</span><span class="p">[</span><span class="s">&#39;office&#39;</span><span class="p">],</span> <span class="s">&#39;value-type&#39;</span> <span class="p">)</span>
    <span class="c"># Get the type</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">type_name</span><span class="o">=</span> <span class="n">cell_doc</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">type_attr_id</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="n">value</span><span class="o">=</span> <span class="bp">None</span>
    <span class="c"># Date value as attribute?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="o">=</span> <span class="n">cell_doc</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">date_attr_id</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="c"># Other value as attribute?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="o">=</span> <span class="n">cell_doc</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">value_attr_id</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="c"># No value attributes, get *all* the text content.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">value</span><span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cell_doc</span><span class="o">.</span><span class="n">itertext</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="c"># TODO: Proper warning.</span>
        <span class="n">dom</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span> <span class="n">cell_doc</span> <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">type_name</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">&quot;float&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">NumberCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">&quot;date&quot;</span><span class="p">:</span>
        <span class="n">theDate</span><span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">ODS_Workbook</span><span class="o">.</span><span class="n">date_format</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">FloatDateCell</span><span class="p">(</span> <span class="n">theDate</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">&quot;boolean&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">BooleanCell</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;TRUE&#39;</span><span class="p">),</span>  <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">&quot;empty&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Unknown cell {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">cell_doc</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<p>An <tt class="docutils literal"><span class="pre">iterparse</span></tt> version of building a row
would look for start of <tt class="docutils literal"><span class="pre">table</span></tt> tags and then get
the name attribute from that tag just to locate the right sheet.</p>
<p>Once the sheet was located, then the row and cell tags would be used</p>
<ul class="simple">
<li>At <tt class="samp docutils literal"><span class="pre">&lt;table-row</span></tt> start: increment row number, reset buffer</li>
<li>At <tt class="samp docutils literal"><span class="pre">&lt;table-row</span></tt> end: yield the row</li>
<li>At <tt class="samp docutils literal"><span class="pre">&lt;table-cell</span></tt> start: check for empty, date, float, boolean types,
which are available as an attribute at start.
For strings, start accumulating string values.</li>
<li>At <tt class="samp docutils literal"><span class="pre">&lt;table-cell</span></tt> end: finalize the accumulated value.</li>
</ul>
</div>
<div class="section" id="numbers-09-workbook">
<h3>8.6.6. Numbers 09 Workbook<a class="headerlink" href="#numbers-09-workbook" title="Permalink to this headline">¶</a></h3>
<p>The Stingray model of sheet/row/cell structure does not
easily fit the Numbers sheet/table/row/cell structure.</p>
<p>Option 1:</p>
<blockquote>
<div>Workbook -&gt; new layer (Numbers &#8220;Workspace&#8221;) -&gt; Sheet (Numbers &#8220;Table&#8221;) -&gt; Row -&gt; Cell</div></blockquote>
<p>Option 2:</p>
<blockquote>
<div><p>Combine (Workspace,Table) into a 2-tuple, and call this a &#8220;sheet&#8221; name</p>
<p>This will fit with Stingray acceptably.</p>
</div></blockquote>
<p>The iWork 09 format is a (simpler) Zip file with an XML document inside it.
There may be slight variations between native Numbers &#8216;09 and Numbers &#8216;13 doing
a &#8220;save as&#8221; in Numbers &#8216;09 format.</p>
<p>Numbers &#8216;13 is entirely different. See <a class="reference internal" href="#numbers-13-workbook">Numbers 13 Workbook</a>.</p>
<dl class="class">
<dt id="workbook.Numbers09_Workbook">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">Numbers09_Workbook</tt><a class="headerlink" href="#workbook.Numbers09_Workbook" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Numbers09_Workbook</span><span class="p">(</span> <span class="n">Workbook</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mac OS X Numbers Workbook for iWork 09.</span>

<span class="sd">    The ``.numbers`` &quot;file&quot; is a ZIP file.</span>
<span class="sd">    The index.xml is the interesting part of this.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NUMBERS_NS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;ls&quot;</span><span class="p">:</span><span class="s">&quot;http://developer.apple.com/namespaces/ls&quot;</span><span class="p">,</span>
    <span class="s">&quot;sf&quot;</span><span class="p">:</span><span class="s">&quot;http://developer.apple.com/namespaces/sf&quot;</span><span class="p">,</span>
    <span class="s">&quot;sfa&quot;</span><span class="p">:</span><span class="s">&quot;http://developer.apple.com/namespaces/sfa&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">row_debug</span><span class="o">=</span> <span class="bp">False</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>
<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object. Ignored for v3.2 numbers files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span> <span class="n">file_object</span> <span class="ow">or</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;r&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare</span><span class="p">()</span>
</pre></div>
</div>
<p>As preparation for reading these files, we locate all the sheet names
and all the number styles.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locate sheets/tables and styles.&quot;&quot;&quot;</span>
    <span class="n">root</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;index.xml&#39;</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_locate_sheets</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_get_styles</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</pre></div>
</div>
<p>Locating all the sheets is a matter of doing an XPath search for
<tt class="samp docutils literal"><span class="pre">workspace-array/workspace</span></tt> and getting the <tt class="docutils literal"><span class="pre">workspace-name</span></tt> attribute
from the  <tt class="samp docutils literal"><span class="pre">&lt;table</span> <span class="pre">name=&quot;</span><em><span class="pre">name</span></em><span class="pre">&quot;&gt;</span></tt> tags.</p>
<p>Within each workspace we have to find <tt class="samp docutils literal"><span class="pre">page-info/tabular-info/tabular-model</span></tt> to
get the tables within the workspaces.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_locate_sheets</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">root</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create ``workspace_table`` map from name to workspace and table.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">ws_name_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;ls&quot;</span><span class="p">],</span> <span class="s">&#39;workspace-name&#39;</span> <span class="p">)</span>
    <span class="n">name_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;name&#39;</span> <span class="p">)</span>
    <span class="n">workspace_array</span><span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;ls:workspace-array&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">workspace</span> <span class="ow">in</span> <span class="n">workspace_array</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;.//ls:workspace&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span> <span class="p">):</span>
        <span class="c"># Populate tables within this workspace.</span>
        <span class="n">tables</span><span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">page_info</span> <span class="o">=</span> <span class="n">workspace</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;ls:page-info&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tabular_info</span> <span class="ow">in</span> <span class="n">page_info</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;.//sf:tabular-info&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">):</span>
            <span class="n">tabular_model</span> <span class="o">=</span> <span class="n">tabular_info</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="s">&#39;sf:tabular-model&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
            <span class="n">tables</span><span class="p">[</span> <span class="n">tabular_model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">tabular_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span> <span class="n">workspace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ws_name_attr</span><span class="p">)</span> <span class="p">]</span><span class="o">=</span> <span class="n">workspace</span><span class="p">,</span> <span class="n">tables</span>
</pre></div>
</div>
<p>Locate a &#8220;data source&#8221; within the XML document. Create <tt class="docutils literal"><span class="pre">Cell</span></tt> instances.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_datasource</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">grid</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The data source for cell values within a grid.</span>
<span class="sd">    This yields each individual cell value, transformed into</span>
<span class="sd">    string, Decimal, datetime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datasource</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.//sf:datasource&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cell_doc</span> <span class="ow">in</span> <span class="n">datasource</span><span class="p">:</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span> <span class="n">cell_doc</span> <span class="p">)</span>
    <span class="c"># or return map( self.cell, datasource )</span>
</pre></div>
</div>
<p>Create a <tt class="docutils literal"><span class="pre">Cell</span></tt> instance from the decoded data.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">cell</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cell</span> <span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">date_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;d&#39;</span> <span class="p">)</span>
    <span class="n">date_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;cell-date&#39;</span> <span class="p">)</span>
    <span class="n">formula_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;f&#39;</span> <span class="p">)</span>
    <span class="n">s_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;s&#39;</span> <span class="p">)</span>
    <span class="n">v_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;v&#39;</span> <span class="p">)</span>
    <span class="n">general_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;g&#39;</span> <span class="p">)</span>
    <span class="n">number_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;n&#39;</span> <span class="p">)</span>
    <span class="n">text_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;t&#39;</span> <span class="p">)</span>
    <span class="n">o_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;o&#39;</span> <span class="p">)</span>
    <span class="n">span_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;s&#39;</span> <span class="p">)</span>
    <span class="n">bool_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;b&#39;</span> <span class="p">)</span>
    <span class="n">popup_menu_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;pm&#39;</span> <span class="p">)</span>
    <span class="n">IDREF_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sfa&quot;</span><span class="p">],</span> <span class="s">&#39;IDREF&#39;</span> <span class="p">)</span>
    <span class="n">ID_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sfa&quot;</span><span class="p">],</span> <span class="s">&#39;ID&#39;</span> <span class="p">)</span>
    <span class="n">fs_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span><span class="s">&quot;fs&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">date_tag</span><span class="p">:</span>
        <span class="n">seconds</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">date_attr</span><span class="p">])</span>
        <span class="n">epoch</span><span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">delta</span><span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span> <span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span> <span class="p">)</span>
        <span class="n">theDate</span><span class="o">=</span> <span class="n">epoch</span> <span class="o">+</span> <span class="n">delta</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">FloatDateCell</span><span class="p">(</span> <span class="n">theDate</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">cell</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">formula_tag</span><span class="p">:</span> <span class="c"># formula or error.</span>
        <span class="n">s</span><span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s_attr</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;sf:fo&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
        <span class="c"># Numeric Result? What about non-numeric results?</span>
        <span class="n">r</span><span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;sf:r&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="c"># Result:</span>
            <span class="n">rn</span><span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;sf:rn&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value_txt</span><span class="o">=</span> <span class="n">rn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">v_attr</span><span class="p">]</span>
                <span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_decimal</span><span class="p">(</span> <span class="n">value_txt</span><span class="p">,</span> <span class="n">s</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="c">#self._cell_warning(&quot;Formula with no value&quot;, cell)</span>
                <span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_decimal</span><span class="p">(</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">NumberCell</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Error:</span>
            <span class="c">#self._cell_warning(&quot;Formula error&quot;, cell)</span>
            <span class="n">value</span><span class="o">=</span> <span class="s">&quot;#Error in {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fs_attr</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">ErrorCell</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">cell</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">general_tag</span><span class="p">:</span> <span class="c"># General?</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">cell</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">number_tag</span><span class="p">:</span> <span class="c"># number</span>
        <span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_number</span><span class="p">(</span> <span class="n">cell</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">NumberCell</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">cell</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">o_tag</span><span class="p">:</span> <span class="c">#??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cell_warning</span><span class="p">(</span><span class="s">&quot;Unknown cell type&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">cell</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">span_tag</span><span class="p">:</span> <span class="c">#span?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cell_warning</span><span class="p">(</span><span class="s">&quot;Unknown cell type&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">cell</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">text_tag</span><span class="p">:</span> <span class="c"># text</span>
        <span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_text</span><span class="p">(</span> <span class="n">cell</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">cell</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">bool_tag</span><span class="p">:</span> <span class="c"># boolean</span>
        <span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_number</span><span class="p">(</span> <span class="n">cell</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">BooleanCell</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">cell</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">popup_menu_tag</span><span class="p">:</span> <span class="c"># popup menu</span>
        <span class="c"># TODO:: Better Xpath query: ``menu-choices/*[@ID=&#39;name&#39;]``</span>
        <span class="n">value</span><span class="o">=</span> <span class="bp">None</span> <span class="c"># In case we can&#39;t find anything.</span>
        <span class="n">selected</span><span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;sf:proxied-cell-ref&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
        <span class="n">name</span><span class="o">=</span> <span class="n">selected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">IDREF_attr</span><span class="p">)</span>
        <span class="n">mc</span><span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;sf:menu-choices&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID_attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="c"># t&#39;s tag cold end in Could be &quot;t&quot;, or &quot;n&quot;.</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">):</span> <span class="c"># Text</span>
                    <span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_text</span><span class="p">(</span> <span class="n">t</span> <span class="p">)</span>
                    <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">):</span> <span class="c"># Number</span>
                    <span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_number</span><span class="p">(</span> <span class="n">t</span> <span class="p">)</span>
                    <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">NumberCell</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Unknown popup menu {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">cell</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Unknown cell {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<p>Some lower-level conversions.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_to_decimal</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value_txt</span><span class="p">,</span> <span class="n">style_id</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a given numeric value_text using the named style.</span>

<span class="sd">    TODO: From the style, get the number of decimal places, use that to</span>
<span class="sd">    build a string version of the float value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fdp_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;format-decimal-places&#39;</span> <span class="p">)</span>
    <span class="n">fs_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;format-string&#39;</span> <span class="p">)</span>
    <span class="n">cell_style</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_style</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">style_id</span><span class="p">)</span>
    <span class="c">#print( &quot;TO_DECIMAL&quot;, value_txt, style_id, &quot;=&quot;, cell_style )</span>

    <span class="n">fs</span><span class="o">=</span> <span class="bp">None</span> <span class="c"># cell_style.get(fs_attr) # Doesn&#39;t seem correct</span>
    <span class="n">fdp</span><span class="o">=</span> <span class="bp">None</span> <span class="c"># cell_style.get(fdp_attr) # Doesn&#39;t seem correct</span>
    <span class="c"># Transform fs into proper Python format, otherwise, use the number of</span>
    <span class="c"># decimal places.</span>
    <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fmt</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_fmt</span><span class="p">(</span> <span class="n">fs</span> <span class="p">)</span>
        <span class="c">#print( &quot;Decimal: {{0:{0}}}.format({1}) = &quot;.format( fmt, value_txt ), end=&quot;&quot; )</span>
        <span class="n">value</span><span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span> <span class="s">&quot;{:{fmt}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value_txt</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span> <span class="p">)</span>
        <span class="c">#print( value )</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">fdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">#fmt= &quot;{{0:.{0}f}}&quot;.format(fdp)</span>
        <span class="n">value</span><span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span> <span class="s">&quot;{:.{fdp}f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value_txt</span><span class="p">),</span> <span class="n">fdp</span><span class="o">=</span><span class="n">fdp</span><span class="p">)</span> <span class="p">)</span>
        <span class="c">#print( &quot;Decimal: {0}.format({1}) = {2!r}&quot;.format( fmt, value_txt, value ) )</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span><span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span> <span class="n">value_txt</span> <span class="p">)</span>
        <span class="c">#print( &quot;Decimal: {0} = {1!r}&quot;.format( value_txt, value ) )</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_decode_text</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cell</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decode a &lt;t&gt; tag&#39;s value.&quot;&quot;&quot;</span>
    <span class="n">sfa_s_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sfa&quot;</span><span class="p">],</span> <span class="s">&#39;s&#39;</span> <span class="p">)</span>
    <span class="n">ct</span><span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="s">&#39;sf:ct&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span> <span class="p">)</span>
    <span class="n">value</span><span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sfa_s_attr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">value</span><span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cell</span><span class="o">.</span><span class="n">itertext</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_decode_number</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cell</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decode a &lt;n&gt; tag&#39;s value, applying the style.&quot;&quot;&quot;</span>
    <span class="n">s_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;s&#39;</span> <span class="p">)</span>
    <span class="n">v_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;v&#39;</span> <span class="p">)</span>
    <span class="n">s</span><span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s_attr</span><span class="p">)</span>
    <span class="n">cell_style</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_style</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value_txt</span><span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">v_attr</span><span class="p">]</span>
        <span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_decimal</span><span class="p">(</span> <span class="n">value_txt</span><span class="p">,</span> <span class="n">s</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c">#self._cell_warning(&quot;Number with no value&quot;, cell)</span>
        <span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_decimal</span><span class="p">(</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
<p>The styles are also important because we can use them to parse the numbers more
precisely.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_styles</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">root</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the styles.&quot;&quot;&quot;</span>
    <span class="n">ID_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sfa&quot;</span><span class="p">],</span> <span class="s">&#39;ID&#39;</span> <span class="p">)</span>
    <span class="n">ident_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;ident&#39;</span> <span class="p">)</span>
    <span class="n">parent_ident_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;parent-ident&#39;</span> <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cell_style</span><span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;.//sf:cell-style&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">):</span>
        <span class="c">#print( &quot;STYLE&quot;, dom.tostring(cs) )</span>
        <span class="n">ID</span><span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID_attr</span><span class="p">)</span>
        <span class="n">ident</span><span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ident_attr</span><span class="p">)</span>
        <span class="n">parent_ident</span><span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_ident_attr</span><span class="p">)</span>
        <span class="n">property_number_format</span><span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.//sf:SFTCellStylePropertyNumberFormat&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">property_number_format</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent_ident</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_style</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_style</span><span class="p">[</span><span class="n">parent_ident</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">number_format</span><span class="o">=</span> <span class="n">property_number_format</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;sf:number-format&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">number_format</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parent_ident</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cell_style</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_style</span><span class="p">[</span><span class="n">parent_ident</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_style</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span> <span class="n">number_format</span><span class="o">.</span><span class="n">attrib</span>
                <span class="k">if</span> <span class="n">ident</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cell_style</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span><span class="o">=</span> <span class="n">number_format</span><span class="o">.</span><span class="n">attrib</span>
            <span class="c">#print( ID, self.cell_style.get(ID,None) )</span>
</pre></div>
</div>
<p>Rewrite a number format from Numbers to Python</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_rewrite_fmt</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the mini-language: &#39;#,##0.###;-#,##0.###&#39; is an example.</span>
<span class="sd">    This becomes &quot;{:10,.3f}&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">positive</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">negative</span> <span class="o">=</span> <span class="n">format_string</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">fmt</span><span class="o">=</span> <span class="n">negative</span> <span class="ow">or</span> <span class="n">positive</span>
    <span class="n">digits</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">comma</span><span class="o">=</span> <span class="s">&quot;,&quot;</span> <span class="k">if</span> <span class="s">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">fmt</span> <span class="k">else</span> <span class="s">&quot;&quot;</span>
    <span class="n">whole</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">precision</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frac</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;{digits}{comma}.{precision}f&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">digits</span><span class="o">=</span> <span class="n">digits</span><span class="p">,</span> <span class="n">comma</span><span class="o">=</span><span class="n">comma</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span> <span class="p">)</span>
</pre></div>
</div>
<p>The &#8220;sheets&#8221; are the <tt class="docutils literal"><span class="pre">[</span> <span class="pre">(</span></tt> <em>workspace</em><cite>,</cite> <em>table</em> <tt class="docutils literal"><span class="pre">),</span> <span class="pre">...</span> <span class="pre">]</span></tt> pairs.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build &quot;sheet&quot; names from workspace/table&quot;&quot;&quot;</span>
    <span class="n">sheet_list</span><span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">w_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">:</span>
        <span class="n">ws</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="n">w_name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t_name</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="n">sheet_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">w_name</span><span class="p">,</span> <span class="n">t_name</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">sheet_list</span>
</pre></div>
</div>
<p>Picking a sheet involves matching a two-part name: (workspace, table).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">rows_of</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator over rows.</span>

<span class="sd">    Two parallel traversals:</span>

<span class="sd">    Internal iterator over grid/datasource/* has d, t, n, pm, g, o and s</span>
<span class="sd">        yields individual cell values.</span>

<span class="sd">    Iterator over grid/rows/grid-row may have ``nc``, number of columns in that row.</span>
<span class="sd">        Each grid-row fetches a number of cell values to assemble a row.</span>
<span class="sd">        Row&#39;s may be variable length (sigh) but padded to the number of columns</span>
<span class="sd">        specified in the grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#print( self.__class__.__qualname__, sheet, sheet.name )</span>
    <span class="n">ws_name</span><span class="p">,</span> <span class="n">t_name</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">name</span>
    <span class="n">ws</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="n">ws_name</span><span class="p">]</span>
    <span class="n">tabular_model</span><span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="n">t_name</span><span class="p">]</span>

    <span class="n">grid</span><span class="o">=</span> <span class="n">tabular_model</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="s">&#39;sf:grid&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span> <span class="p">)</span>
    <span class="n">numrows_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;numrows&#39;</span> <span class="p">)</span>
    <span class="n">numcols_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;numcols&#39;</span> <span class="p">)</span>
    <span class="n">numrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">numrows_attr</span><span class="p">])</span>
    <span class="n">numcols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">numcols_attr</span><span class="p">])</span>

    <span class="n">nc_attr</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">[</span><span class="s">&quot;sf&quot;</span><span class="p">],</span> <span class="s">&#39;nc&#39;</span> <span class="p">)</span>

    <span class="n">datasource</span><span class="o">=</span> <span class="nb">iter</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasource</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;sf:rows&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span> <span class="s">&#39;sf:grid-row&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBERS_NS</span> <span class="p">)):</span>
        <span class="c">#print( &quot;ROW&quot;, dom.tostring(r) )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_row</span><span class="o">=</span> <span class="n">n</span>
        <span class="c"># Is this really relevant for Numbers &#39;09?</span>
        <span class="n">nc</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nc_attr</span><span class="p">,</span><span class="n">numcols</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">row</span><span class="o">=</span> <span class="p">[</span> <span class="nb">next</span><span class="p">(</span><span class="n">datasource</span><span class="p">)</span> <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># Last row will exhaust the datasource.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="n">numcols</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">row</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">row</span> <span class="o">+</span> <span class="p">(</span><span class="n">numcols</span><span class="o">-</span><span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="bp">None</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="numbers-13-workbook">
<h3>8.6.7. Numbers 13 Workbook<a class="headerlink" href="#numbers-13-workbook" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p>Implement Numbers13_Workbook</p>
<p class="last">Use snappy and protobuf to read the IWA members of the archive.</p>
</div>
<p>The iWork 13 format is a directory with an <tt class="docutils literal"><span class="pre">index.zip</span></tt> file. The ZIP contains
a number of <tt class="docutils literal"><span class="pre">.IWA</span></tt> files. Each <tt class="docutils literal"><span class="pre">.IWA</span></tt> is compressed using the Snappy protocol.
The uncompressed data is messages in Protobuf format.</p>
<p>We could depend on proper Snappy and Protobuf implementations. We provide
our own fall-back implementation in case there&#8217;s nothing better available.</p>
<p>We should import other implementations first, and then fall back to our own implementation.
Instead, we&#8217;ll simply import a local snappy and protobuf reader.</p>
<dl class="class">
<dt id="workbook.Numbers13_Workbook">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">Numbers13_Workbook</tt><a class="headerlink" href="#workbook.Numbers13_Workbook" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Numbers13_Workbook</span><span class="p">(</span> <span class="n">Workbook</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mac OS X Numbers Workbook for iWork &#39;13.</span>

<span class="sd">    The ``.numbers`` &quot;file&quot; is a directory bundle or package.</span>
<span class="sd">    The ``index.zip`` file is the interesting part of the bundle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>
<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object. Ignored for iWork13 files.</span>
<span class="sd">            Although, we might be able to use the internal handle to open</span>
<span class="sd">            it as a proper directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numbers_package</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;index.zip&quot;</span> <span class="p">)</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">numbers_package</span> <span class="p">)</span> <span class="k">as</span> <span class="n">index</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="n">n</span> <span class="p">)</span>
                <span class="k">with</span> <span class="n">index</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">n</span> <span class="p">)</span> <span class="k">as</span> <span class="n">member</span><span class="p">:</span>
                    <span class="k">pass</span>    <span class="c"># snappy/protobuf reader.</span>
</pre></div>
</div>
</div>
<div class="section" id="workbook-factory">
<h3>8.6.8. Workbook Factory<a class="headerlink" href="#workbook-factory" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="workbook.No_Schema">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">No_Schema</tt><a class="headerlink" href="#workbook.No_Schema" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>The <a class="reference internal" href="#workbook.No_Schema" title="workbook.No_Schema"><tt class="xref py py-class docutils literal"><span class="pre">No_Schema</span></tt></a> exception is raised if there&#8217;s a problem
loading the schema.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">No_Schema</span><span class="p">(</span> <span class="ne">Exception</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A valid schema could not be loaded.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>
</div>
<dl class="class">
<dt id="workbook.Opener">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">Opener</tt><a class="headerlink" href="#workbook.Opener" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>An opener <strong>Factory</strong> class.  A subclass can extend this to handle other file
extensions and physical formats.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Opener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An extensible opener that examines the file extension.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">schema_path</span><span class="o">=</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="n">schema_sheet</span><span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a workbook.</span>
<span class="sd">        :param name: filename to open.</span>
<span class="sd">        :param file_object: File-like object to process.  If not</span>
<span class="sd">        provided the named file will be opened.</span>
<span class="sd">        :param schema_path: Directory with external schema files</span>
<span class="sd">        :param schema_sheet: A sheet in an external schema workbook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span> <span class="n">name</span> <span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;.xls&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">XLS_Workbook</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span> <span class="s">&quot;.xlsx&quot;</span><span class="p">,</span> <span class="s">&quot;.xlsm&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">XLSX_Workbook</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span> <span class="s">&quot;.csv&quot;</span><span class="p">,</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">CSV_Workbook</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span> <span class="s">&quot;.tab&quot;</span><span class="p">,</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">CSV_Workbook</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span> <span class="s">&quot;.ods&quot;</span><span class="p">,</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">ODS_Workbook</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span> <span class="s">&quot;.numbers&quot;</span><span class="p">,</span> <span class="p">):</span>
            <span class="c"># Directory? It&#39;s Numbers13_Workbook; Zipfile? It&#39;s Numbers09_Workbook</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">(</span> <span class="n">name</span> <span class="p">):</span>
                <span class="k">return</span> <span class="n">Numbers13_Workbook</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Numbers09_Workbook</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Ideally somefile.schema is the file</span>
            <span class="c"># and schema.csv can be tracked down.</span>
            <span class="n">schema_pat</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">schema_path</span><span class="p">,</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="s">&quot;.*&quot;</span><span class="p">)</span>
            <span class="n">schema_choices</span><span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span> <span class="n">schema_pat</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">schema_choices</span><span class="p">:</span>
                <span class="n">schema_name</span><span class="o">=</span> <span class="n">schema_choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">schema_wb</span><span class="o">=</span> <span class="n">open_workbook</span><span class="p">(</span> <span class="n">schema_name</span> <span class="p">)</span>
                <span class="n">esl</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">ExternalSchemaLoader</span><span class="p">(</span> <span class="n">schema_wb</span><span class="p">,</span> <span class="n">schema_sheet</span> <span class="p">)</span>
                <span class="n">schema</span><span class="o">=</span> <span class="n">esl</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">Fixed_Workbook</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">No_Schema</span><span class="p">(</span> <span class="n">schema_pat</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="function">
<dt id="workbook.open_workbook">
<tt class="descclassname">workbook.</tt><tt class="descname">open_workbook</tt><big>(</big><em>name</em>, <em>file_object</em>, <em>schema_path</em>, <em>schema_sheet</em><big>)</big><a class="headerlink" href="#workbook.open_workbook" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>The default <a class="reference internal" href="#workbook.open_workbook" title="workbook.open_workbook"><tt class="xref py py-func docutils literal"><span class="pre">workbook.open_workbook()</span></tt></a> is simply an instance
of the <a class="reference internal" href="#workbook.Opener" title="workbook.Opener"><tt class="xref py py-class docutils literal"><span class="pre">workbook.Opener</span></tt></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">open_workbook</span><span class="o">=</span> <span class="n">Opener</span><span class="p">()</span>
</pre></div>
</div>
<p>This allows a user to create subclasses to handle the various other file name extensions.
Often, there are application-specific rules, or command-line options that
will determine a mapping bewtween filename and physical format.</p>
<p>Also, an application may require external schema, or there may be an optional
external schema with application-specific rules for handling this.</p>
<p>For fixed format files, we attempt to track down and load the relevant
schema.  An application might have narrower and more specific rules
for binding file and schema.  See below for the <a class="reference internal" href="schema_loader.html#schema.loader.ExternalSchemaLoader" title="schema.loader.ExternalSchemaLoader"><tt class="xref py py-class docutils literal"><span class="pre">schema.loader.ExternalSchemaLoader</span></tt></a> class.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/Stingray_belon1553_small.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">8. Workbook Module &#8211; Uniform Wrapper on All Workbooks</a><ul>
<li><a class="reference internal" href="#use-case">8.1. Use Case</a></li>
<li><a class="reference internal" href="#physical-formats">8.2. Physical Formats</a></li>
<li><a class="reference internal" href="#model">8.3. Model</a></li>
<li><a class="reference internal" href="#implementation-overheads">8.4. Implementation Overheads</a></li>
<li><a class="reference internal" href="#workbook-structure">8.5. Workbook Structure</a></li>
<li><a class="reference internal" href="#workbook-subclasses">8.6. Workbook Subclasses</a><ul>
<li><a class="reference internal" href="#csv-workbook">8.6.1. CSV Workbook</a></li>
<li><a class="reference internal" href="#xls-workbook">8.6.2. XLS Workbook</a></li>
<li><a class="reference internal" href="#xlsx-or-xlsm-workbook">8.6.3. XLSX or XLSM Workbook</a></li>
<li><a class="reference internal" href="#fixed-format-workbook">8.6.4. Fixed-Format Workbook</a></li>
<li><a class="reference internal" href="#ods-workbook">8.6.5. ODS Workbook</a></li>
<li><a class="reference internal" href="#numbers-09-workbook">8.6.6. Numbers 09 Workbook</a></li>
<li><a class="reference internal" href="#numbers-13-workbook">8.6.7. Numbers 13 Workbook</a></li>
<li><a class="reference internal" href="#workbook-factory">8.6.8. Workbook Factory</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="schema_loader.html"
                        title="previous chapter">7. Schema Loader Module &#8211; Load Embedded or External Schema</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="iwork13.html"
                        title="next chapter">9. The iWork &#8216;13 Numbers Modules</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/workbook.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="iwork13.html" title="9. The iWork ‘13 Numbers Modules"
             >next</a> |</li>
        <li class="right" >
          <a href="schema_loader.html" title="7. Schema Loader Module – Load Embedded or External Schema"
             >previous</a> |</li>
        <li><a href="index.html">The Stingray Schema-Based File Reader</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, S. Lott.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>