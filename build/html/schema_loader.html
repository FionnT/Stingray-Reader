<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>7. Schema Loader Module – Load Embedded or External Schema &mdash; The Stingray Schema-Based File Reader</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4.4.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="The Stingray Schema-Based File Reader" href="index.html" />
    <link rel="next" title="8. Workbook Package – Uniform Wrappers for Workbooks" href="workbook/index.html" />
    <link rel="prev" title="6. Schema Package – Schema and Attribute Definitions" href="schema.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="workbook/index.html" title="8. Workbook Package – Uniform Wrappers for Workbooks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="schema.html" title="6. Schema Package – Schema and Attribute Definitions"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">The Stingray Schema-Based File Reader</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-schema.loader">
<span id="schema-loader-module-load-embedded-or-external-schema"></span><span id="schema-loader"></span><h1>7. Schema Loader Module &#8211; Load Embedded or External Schema<a class="headerlink" href="#module-schema.loader" title="Permalink to this headline">¶</a></h1>
<p>A <em>Schema Loader</em> loads the attributes of a schema from a source document.
There are a variety of sources.</p>
<ul class="simple">
<li>The first row of a sheet within a workbook.
This version has to be injected into workbook processing
so that the first row is separated from the data rows.</li>
<li>A separate sheet of a workbook.
This version requires a sheet name.</li>
<li>A separate workbook.  This, too, requires a named sheet.</li>
<li>COBOL Code.  We&#8217;ll set this aside as a subclass
so complex it requires it&#8217;s own module.</li>
</ul>
<p>A schema loader is paired with a specific kind of <a class="reference internal" href="sheet.html#sheet.Sheet" title="sheet.Sheet"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Sheet</span></tt></a>.</p>
<p>A workbook requires a schema, which requires a schema loader.
A schema loader depends on a meta-workbook.  Ideally that meta-workbook has
an emedded schema, but it may have an external schema, meaning we could have a
meta-schema required load the schema for the application data.  Sheesh.</p>
<p>First, let&#8217;s hope that doesn&#8217;t happen.  Second, the circularity is resolved by making it the responsibility of the
the application to handle schema loading.</p>
<div class="section" id="embedded-schema-use-case">
<h2>7.1. Embedded Schema Use Case<a class="headerlink" href="#embedded-schema-use-case" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="sheet.html#sheet.EmbeddedSchemaSheet" title="sheet.EmbeddedSchemaSheet"><tt class="xref py py-class docutils literal"><span class="pre">sheet.EmbeddedSchemaSheet</span></tt></a> requires a loader class.
The loader will</p>
<ol class="arabic simple">
<li>Be built with the sheet as an argument.</li>
<li>Be interrogated for the schema.</li>
<li>Be interrogated for the rows.</li>
</ol>
<p>The most typical case is the single-header-row case.</p>
<p>In some cases, the loader is actually a
a rather sophisticated parser that paritions the data into the embedded schema
and the data rows.</p>
<pre class="literal-block">
with Workbook( name ) as wb:
    sheet = self.wb.sheet( 'Sheet2',
        stingray.sheet.EmbeddedSchemaSheet,
        loader_class= stingray.schema.loader.HeadingRowSchemaLoader )

    for row in sheet.rows():
        <em>process the row</em>
</pre>
</div>
<div class="section" id="external-schema-use-case">
<h2>7.2. External Schema Use Case<a class="headerlink" href="#external-schema-use-case" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="sheet.html#sheet.ExternalSchemaSheet" title="sheet.ExternalSchemaSheet"><tt class="xref py py-class docutils literal"><span class="pre">sheet.ExternalSchemaSheet</span></tt></a> requires a schema.</p>
<p>In the typical case, the external schema file has an emedded meta-schema.
The first row has appropriate column names.
This requires a subclass of <a class="reference internal" href="#schema.loader.ExternalSchemaLoader" title="schema.loader.ExternalSchemaLoader"><tt class="xref py py-class docutils literal"><span class="pre">schema.loader.ExternalSchemaLoader</span></tt></a> to properly map the names that were found onto the attributes of the <a class="reference internal" href="schema.html#schema.Attribute" title="schema.Attribute"><tt class="xref py py-class docutils literal"><span class="pre">schema.Attribute</span></tt></a> class.</p>
<p>When the embedded meta-schema has unusual names, then a builder must be defined
to map the names that are found in the schema and build an <a class="reference internal" href="schema.html#schema.Attribute" title="schema.Attribute"><tt class="xref py py-class docutils literal"><span class="pre">schema.Attribute</span></tt></a> instance.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="n">open_workbook</span><span class="p">(</span> <span class="n">schema_name</span> <span class="p">)</span> <span class="k">as</span> <span class="n">schema_wb</span><span class="p">:</span>
    <span class="n">esl</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">ExternalSchemaLoader</span><span class="p">(</span> <span class="n">schema_wb</span><span class="p">,</span> <span class="s">&quot;Schema&quot;</span> <span class="p">)</span>
    <span class="n">schema</span><span class="o">=</span> <span class="n">esl</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span>
<span class="k">with</span> <span class="n">Workbook</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="p">)</span> <span class="k">as</span> <span class="n">wb</span><span class="p">:</span>
    <span class="n">sheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">sheet</span><span class="p">(</span> <span class="s">&#39;Sheet2&#39;</span><span class="p">,</span>
        <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">ExternalSchemaSheet</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span> <span class="n">schema</span> <span class="p">)</span>
    <span class="n">counts</span><span class="o">=</span> <span class="n">process_sheet</span><span class="p">(</span> <span class="n">sheet</span> <span class="p">)</span>
    <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span> <span class="n">counts</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="manual-schema-use-case">
<h2>7.3. Manual Schema Use Case<a class="headerlink" href="#manual-schema-use-case" title="Permalink to this headline">¶</a></h2>
<p>Also, a manually-defined <a class="reference internal" href="schema.html#schema.Schema" title="schema.Schema"><tt class="xref py py-class docutils literal"><span class="pre">schema.Schema</span></tt></a> can be built rather than being loaded.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">schema</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Schema</span><span class="p">(</span>
    <span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Column #1&#39;</span> <span class="p">),</span>
    <span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Key&#39;</span> <span class="p">),</span>
    <span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Value&#39;</span> <span class="p">),</span>
    <span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Etc.&#39;</span> <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="model">
<h2>7.4. Model<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none"><div class="highlight"><pre>http://yuml.me/diagram/scruffy;/class/
#schema-loader,
[Schema]&lt;&gt;-[Attribute],
[SchemaLoader]-builds-&gt;[Schema],
[SchemaLoader]^[HeadingRowSchemaLoader],
[SchemaLoader]^[ExternalSchemaLoader],
[ExternalSchemaLoader]-reads-&gt;[Workbook],
[HeadingRowSchemaLoader]-reads-&gt;[Sheet].
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/schema_loader.png"><img alt="_images/schema_loader.png" src="_images/schema_loader.png" style="width: 6in;" /></a>
</div>
<div class="section" id="overheads">
<h2>7.5. Overheads<a class="headerlink" href="#overheads" title="Permalink to this headline">¶</a></h2>
<p>We depend on <a class="reference internal" href="schema.html#module-schema" title="schema"><tt class="xref py py-mod docutils literal"><span class="pre">schema</span></tt></a>, <a class="reference internal" href="cell.html#module-cell" title="cell"><tt class="xref py py-mod docutils literal"><span class="pre">cell</span></tt></a> and <a class="reference internal" href="sheet.html#module-sheet" title="sheet"><tt class="xref py py-mod docutils literal"><span class="pre">sheet</span></tt></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;stingray.schema.loader -- Loads a Schema from a row of a Sheet or</span>
<span class="sd">from a separate Sheet.  This is extended to load COBOL schema</span>
<span class="sd">from DDE files.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">stingray.schema</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">Attribute</span>
<span class="kn">import</span> <span class="nn">stingray.cell</span>
<span class="kn">import</span> <span class="nn">stingray.sheet</span>
<span class="kn">import</span> <span class="nn">warnings</span>
</pre></div>
</div>
</div>
<div class="section" id="no-schema-exception">
<h2>7.6. No Schema Exception<a class="headerlink" href="#no-schema-exception" title="Permalink to this headline">¶</a></h2>
<p>In some circumstances, we can&#8217;t load a schema. The most common situation
is a <a class="reference internal" href="#schema.loader.HeadingRowSchemaLoader" title="schema.loader.HeadingRowSchemaLoader"><tt class="xref py py-class docutils literal"><span class="pre">HeadingRowSchemaLoader</span></tt></a> which is applied to an empty workbook sheet.
No rows means no schema.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NoSchemaFound</span><span class="p">(</span> <span class="ne">Exception</span> <span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The default behavior is to simply write a warning for an empty sheet.
The lack of a schema means there&#8217;s no data, also, and 99% of the time, silently ignoring
an empty sheet is desirable.</p>
</div>
<div class="section" id="id1">
<h2>7.7. Schema Loader<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="schema.loader.SchemaLoader">
<em class="property">class </em><tt class="descclassname">schema.loader.</tt><tt class="descname">SchemaLoader</tt><a class="headerlink" href="#schema.loader.SchemaLoader" title="Permalink to this definition">¶</a></dt>
<dd><p>A Schema Loader has one mandatory contract: It must load the schema.</p>
<p>A subclass may add a second contract, For example,
an embedded schema loader will also return the non-schema rows.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SchemaLoader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Locate schema information.  Subclasses handle</span>
<span class="sd">    all of the variations on schema representation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A simple :py:class:`Sheet` instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">=</span> <span class="n">sheet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_iter</span><span class="o">=</span> <span class="nb">iter</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan the sheet to get the schema.</span>
<span class="sd">        :return: a :py:class:`Schema` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate all (or remaining) rows.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_iter</span>
</pre></div>
</div>
</div>
<div class="section" id="embedded-schema-loader">
<h2>7.8. Embedded Schema Loader<a class="headerlink" href="#embedded-schema-loader" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="schema.loader.HeadingRowSchemaLoader">
<em class="property">class </em><tt class="descclassname">schema.loader.</tt><tt class="descname">HeadingRowSchemaLoader</tt><a class="headerlink" href="#schema.loader.HeadingRowSchemaLoader" title="Permalink to this definition">¶</a></dt>
<dd><p>In many cases, the schema is first-row column titles or something similar.
As we noted above, <tt class="xref py py-class docutils literal"><span class="pre">csv.DictReader</span></tt> supports this simple case.</p>
<p>All other cases have to be handled with something a bit more sophisticated.
The <a class="reference internal" href="#schema.loader.SchemaLoader" title="schema.loader.SchemaLoader"><tt class="xref py py-class docutils literal"><span class="pre">schema.loader.SchemaLoader</span></tt></a> can be further subclassed to provide for more
complex schema definitions buried in the rows of a sheet.</p>
<p>This means that we must make the schema parsing an application-provided
plug-in that the Workbook uses when instantiating each Sheet.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HeadingRowSchemaLoader</span><span class="p">(</span> <span class="n">SchemaLoader</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read just the first row of a sheet to get embedded</span>
<span class="sd">    schema information.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to get the schema from row one.  Remaining rows are data.</span>
<span class="sd">        If the sheet is empty, emit a warning and return ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">row_1</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_iter</span> <span class="p">)</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">to_str</span><span class="p">())</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">row_1</span>
            <span class="p">)</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span>
                <span class="o">*</span><span class="p">(</span><span class="n">Attribute</span><span class="p">(</span><span class="o">**</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">schema</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s">&quot;Empty sheet: no schema present&quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>We&#8217;ll open a <a class="reference internal" href="sheet.html#sheet.Sheet" title="sheet.Sheet"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Sheet</span></tt></a> with a specific loader.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sheet</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">EmbeddedSchemaSheet</span><span class="p">(</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="p">,</span> <span class="s">&#39;The_Name&#39;</span><span class="p">,</span>
    <span class="n">loader_class</span><span class="o">=</span><span class="n">HeadingRowSchemaLoader</span> <span class="p">)</span>
</pre></div>
</div>
<p>In many cases, we&#8217;d like to subclass this to suppress the empty rows that are an inevitable feature of workbook sheets.  This doesn&#8217;t work well for COBOL
or Fixed format files, since an &#8220;empty&#8221; row may be difficult to discern.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NonBlankHeadingRowSchemaLoader</span><span class="p">(</span> <span class="n">HeadingRowSchemaLoader</span> <span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A simple :py:class:`Sheet` instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">=</span> <span class="n">sheet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_iter</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_blank</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">non_blank</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">rows</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span> <span class="n">c</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">r</span> <span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">r</span>
</pre></div>
</div>
</div>
<div class="section" id="external-schema-loader">
<h2>7.9. External Schema Loader<a class="headerlink" href="#external-schema-loader" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="schema.loader.ExternalSchemaLoader">
<em class="property">class </em><tt class="descclassname">schema.loader.</tt><tt class="descname">ExternalSchemaLoader</tt><a class="headerlink" href="#schema.loader.ExternalSchemaLoader" title="Permalink to this definition">¶</a></dt>
<dd><p>In some cases, the data workbook is described by a separate schema workbook, or a separate
sheet within the data workbook.  In these cases, the other sheet (or file) must be
parsed to locate schema information.</p>
<p>In the case of a fixed format file, we must examine a separate
file to load schema information.  This additional schems file may be in
COBOL notation, leading to a more complex parser.  See <a class="reference internal" href="cobol_loader.html#cobol-loader"><em>COBOL Loader Module &#8211; Parse COBOL Source to Load a Schema</em></a>.</p>
<p>The layout of the schema, of course, will be highly variable,
so the &#8220;meta-schema&#8221; must be adjusted to the actual file.</p>
<p>Note, also, that the schema loader is &#8211; itself &#8211; a typical of schema-based reader.  It has a number of common features.</p>
<ol class="arabic simple">
<li>A dictionary-based &#8220;builder&#8221;, <a class="reference internal" href="#schema.loader.ExternalSchemaLoader.build_attr" title="schema.loader.ExternalSchemaLoader.build_attr"><tt class="xref py py-meth docutils literal"><span class="pre">schema.loader.ExternalSchemaLoader.build_attr()</span></tt></a>, to handle Logical Layout.
This transforms the input &#8220;raw&#8221; dictionary of <a class="reference internal" href="cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> instances to an application dictionary of proper Python objects.
See <a class="reference internal" href="developer.html#developer"><em>The Stingray Developer&#8217;s Guide</em></a>.</li>
<li>An iterator, <a class="reference internal" href="#schema.loader.ExternalSchemaLoader.attr_dict_iter" title="schema.loader.ExternalSchemaLoader.attr_dict_iter"><tt class="xref py py-meth docutils literal"><span class="pre">schema.loader.ExternalSchemaLoader.attr_dict_iter()</span></tt></a>,
that provides &#8220;raw&#8221; dictionaries from each row (based on the schema) to the
builder to create application dictionaries.</li>
<li>The overall function,
<a class="reference internal" href="#schema.loader.ExternalSchemaLoader.schema" title="schema.loader.ExternalSchemaLoader.schema"><tt class="xref py py-meth docutils literal"><span class="pre">schema.loader.ExternalSchemaLoader.schema()</span></tt></a>,
that iterates over application objects built from application dictionaries.</li>
</ol>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ExternalSchemaLoader</span><span class="p">(</span> <span class="n">SchemaLoader</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open a workbook file in a well-known format.</span>
<span class="sd">    Build a schema with attribute name, offset, size  and type</span>
<span class="sd">    information.  The type is a string that names the</span>
<span class="sd">    type of cell to create.</span>

<span class="sd">    The meta-schema must be embedded as the first line of the schema sheet.</span>

<span class="sd">    The assumed meta-schema is the following::</span>

<span class="sd">        Schema(</span>
<span class="sd">            Attribute(&quot;name&quot;,create=&quot;TextCell&quot;),</span>
<span class="sd">            Attribute(&quot;offset&quot;,create=&quot;NumberCell&quot;),</span>
<span class="sd">            Attribute(&quot;size&quot;,create=&quot;NumberCell&quot;),</span>
<span class="sd">            Attribute(&quot;type&quot;,create=&quot;TextCell&quot;),</span>
<span class="sd">        )</span>

<span class="sd">    If the meta-schema has different names, then a subclass with</span>
<span class="sd">    a different :py:meth:`build_attr` is required to map the actual</span>
<span class="sd">    source columns to the attributes of a :py:class:`Attribute`.</span>

<span class="sd">    Offsets are typically 1-based.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">workbook</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s">&#39;Sheet1&#39;</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workbook</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">,</span> <span class="n">sheet_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workbook</span><span class="o">.</span><span class="n">sheet</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheet_name</span><span class="p">,</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">EmbeddedSchemaSheet</span><span class="p">,</span>
        <span class="n">loader_class</span><span class="o">=</span> <span class="n">HeadingRowSchemaLoader</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="schema.loader.ExternalSchemaLoader.build_attr">
<tt class="descclassname">ExternalSchemaLoader.</tt><tt class="descname">build_attr</tt><big>(</big><em>row</em><big>)</big><a class="headerlink" href="#schema.loader.ExternalSchemaLoader.build_attr" title="Permalink to this definition">¶</a></dt>
<dd><p>There&#8217;s potential for a great deal of variability in schema definition.
Consequently, this <tt class="docutils literal"><span class="pre">build_attr</span></tt> method is merely a sample that
covers one common case.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="n">base</span><span class="o">=</span> <span class="mi">1</span>
<span class="n">type_to_cell</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="s">&quot;TextCell&quot;</span><span class="p">,</span>
    <span class="s">&#39;number&#39;</span><span class="p">:</span> <span class="s">&quot;NumberCell&quot;</span><span class="p">,</span>
    <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="s">&quot;DateCell&quot;</span><span class="p">,</span>
    <span class="s">&#39;boolean&#39;</span><span class="p">:</span> <span class="s">&quot;BooleanCell&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">build_attr</span><span class="p">(</span> <span class="n">row</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build application dictionary from raw dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">offset</span><span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_int</span><span class="p">()</span><span class="o">-</span><span class="n">ExternalSchemaLoader</span><span class="o">.</span><span class="n">base</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">offset</span><span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">size</span><span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_int</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">size</span><span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">type_name</span><span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_str</span><span class="p">()</span>
        <span class="n">create</span><span class="o">=</span> <span class="n">ExternalSchemaLoader</span><span class="o">.</span><span class="n">type_to_cell</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">create</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">offset</span><span class="o">=</span> <span class="n">offset</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span> <span class="n">size</span><span class="p">,</span>
        <span class="n">create</span><span class="o">=</span> <span class="n">create</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Schema loading involves a process of</p>
<ol class="arabic simple">
<li>Iterating through the source rows as dictionaries.<ul>
<li>Build each raw row as a source dictionary.</li>
<li>Build an standardized attr dictionary from the source dictionary.
This mapping, implemented by <a class="reference internal" href="#schema.loader.ExternalSchemaLoader.build_attr" title="schema.loader.ExternalSchemaLoader.build_attr"><tt class="xref py py-meth docutils literal"><span class="pre">schema.loader.ExternalSchemaLoader.build_attr()</span></tt></a>
is subject to a great deal of change without notice.</li>
</ul>
</li>
<li>Building each <a class="reference internal" href="schema.html#schema.Attribute" title="schema.Attribute"><tt class="xref py py-class docutils literal"><span class="pre">schema.Attribute</span></tt></a> from the dictionary.</li>
</ol>
<dl class="method">
<dt id="schema.loader.ExternalSchemaLoader.attr_dict_iter">
<tt class="descclassname">ExternalSchemaLoader.</tt><tt class="descname">attr_dict_iter</tt><big>(</big><em>sheet</em><big>)</big><a class="headerlink" href="#schema.loader.ExternalSchemaLoader.attr_dict_iter" title="Permalink to this definition">¶</a></dt>
<dd><p>Iterate over application dicts based on raw dicts built by the schema of the sheet.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">attr_dict_iter</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterate over application dicts based on raw dicts</span>
<span class="sd">    built by the schema of the sheet.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">ExternalSchemaLoader</span><span class="o">.</span><span class="n">build_attr</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">rows_as_dict_iter</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="schema.loader.ExternalSchemaLoader.schema">
<tt class="descclassname">ExternalSchemaLoader.</tt><tt class="descname">schema</tt><big>(</big><big>)</big><a class="headerlink" href="#schema.loader.ExternalSchemaLoader.schema" title="Permalink to this definition">¶</a></dt>
<dd><p>Scan a file to get the schema.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">a <tt class="xref py py-class docutils literal"><span class="pre">Schema</span></tt> object</td>
</tr>
</tbody>
</table>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">schema</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scan a file to get the schema.</span>
<span class="sd">    :return: a :py:class:`Schema` object.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row_iter</span><span class="o">=</span> <span class="nb">iter</span><span class="p">(</span> <span class="p">[]</span> <span class="p">)</span>
    <span class="n">source_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_dict_iter</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span> <span class="p">)</span>
    <span class="n">schema</span><span class="o">=</span> <span class="n">Schema</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">Attribute</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">source_dict</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">schema</span>
</pre></div>
</div>
</div>
<div class="section" id="worst-case-loader">
<h2>7.10. Worst-Case Loader<a class="headerlink" href="#worst-case-loader" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="schema.loader.BareExternalSchemaLoader">
<em class="property">class </em><tt class="descclassname">schema.loader.</tt><tt class="descname">BareExternalSchemaLoader</tt><a class="headerlink" href="#schema.loader.BareExternalSchemaLoader" title="Permalink to this definition">¶</a></dt>
<dd><p>This is a degenerate case loader where the schema sheet (or file) doesn&#8217;t have
an embedded schema on line one of the sheet.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">BareExternalSchemaLoader</span><span class="p">(</span> <span class="n">SchemaLoader</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open a workbook file in a well-known format.  Apply a schema parser</span>
<span class="sd">    to the given sheet (or file) to build a schema.</span>

<span class="sd">    The meta-schema is hard-coded in this class because the given</span>
<span class="sd">    sheet has no headers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span><span class="o">=</span> <span class="n">Schema</span><span class="p">(</span>
            <span class="n">Attribute</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="s">&quot;TextCell&quot;</span><span class="p">),</span>
            <span class="n">Attribute</span><span class="p">(</span><span class="s">&quot;offset&quot;</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="s">&quot;NumberCell&quot;</span><span class="p">),</span>
            <span class="n">Attribute</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="s">&quot;NumberCell&quot;</span><span class="p">),</span>
            <span class="n">Attribute</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="s">&quot;TextCell&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">workbook</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s">&#39;Sheet1&#39;</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workbook</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">,</span> <span class="n">sheet_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sheet</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workbook</span><span class="o">.</span><span class="n">sheet</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheet_name</span><span class="p">,</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">ExternalSchemaSheet</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="parsing-and-loading-a-cobol-schema">
<h2>7.11. Parsing and Loading a COBOL Schema<a class="headerlink" href="#parsing-and-loading-a-cobol-schema" title="Permalink to this headline">¶</a></h2>
<p>One logical extension to this is to parse COBOL DDE&#8217;s to create
a schema that allows us to process a COBOL file (in EBCDIC) directly
as if it were a simple workbook.</p>
<p>We&#8217;ll delegate that to <a class="reference internal" href="cobol_loader.html#cobol-loader"><em>COBOL Loader Module &#8211; Parse COBOL Source to Load a Schema</em></a>, since it&#8217;s considerably
more complex than simply loading rows from a sheet of a workbook.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/Stingray_belon1553_small.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7. Schema Loader Module &#8211; Load Embedded or External Schema</a><ul>
<li><a class="reference internal" href="#embedded-schema-use-case">7.1. Embedded Schema Use Case</a></li>
<li><a class="reference internal" href="#external-schema-use-case">7.2. External Schema Use Case</a></li>
<li><a class="reference internal" href="#manual-schema-use-case">7.3. Manual Schema Use Case</a></li>
<li><a class="reference internal" href="#model">7.4. Model</a></li>
<li><a class="reference internal" href="#overheads">7.5. Overheads</a></li>
<li><a class="reference internal" href="#no-schema-exception">7.6. No Schema Exception</a></li>
<li><a class="reference internal" href="#id1">7.7. Schema Loader</a></li>
<li><a class="reference internal" href="#embedded-schema-loader">7.8. Embedded Schema Loader</a></li>
<li><a class="reference internal" href="#external-schema-loader">7.9. External Schema Loader</a></li>
<li><a class="reference internal" href="#worst-case-loader">7.10. Worst-Case Loader</a></li>
<li><a class="reference internal" href="#parsing-and-loading-a-cobol-schema">7.11. Parsing and Loading a COBOL Schema</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="schema.html"
                        title="previous chapter">6. Schema Package &#8211; Schema and Attribute Definitions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="workbook/index.html"
                        title="next chapter">8. Workbook Package &#8211; Uniform Wrappers for Workbooks</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/schema_loader.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="workbook/index.html" title="8. Workbook Package – Uniform Wrappers for Workbooks"
             >next</a> |</li>
        <li class="right" >
          <a href="schema.html" title="6. Schema Package – Schema and Attribute Definitions"
             >previous</a> |</li>
        <li><a href="index.html">The Stingray Schema-Based File Reader</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, S. Lott.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>