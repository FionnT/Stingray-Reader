<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8.5. XLSX or XLSM Workbook &mdash; The Stingray Schema-Based File Reader</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '4.4.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="The Stingray Schema-Based File Reader" href="../index.html" />
    <link rel="up" title="8. Workbook Package – Uniform Wrappers for Workbooks" href="index.html" />
    <link rel="next" title="8.6. ODS Workbook" href="ods.html" />
    <link rel="prev" title="8.4. XLS Workbook" href="xls.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="ods.html" title="8.6. ODS Workbook"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="xls.html" title="8.4. XLS Workbook"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">The Stingray Schema-Based File Reader</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">8. Workbook Package &#8211; Uniform Wrappers for Workbooks</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="xlsx-or-xlsm-workbook">
<span id="workbook-xlsx"></span><h1>8.5. XLSX or XLSM Workbook<a class="headerlink" href="#xlsx-or-xlsm-workbook" title="Permalink to this headline">¶</a></h1>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="kn">as</span> <span class="nn">dom</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">stingray.workbook.base</span> <span class="kn">import</span> <span class="n">Workbook</span>
<span class="kn">import</span> <span class="nn">stingray.sheet</span>
<span class="kn">import</span> <span class="nn">stingray.cell</span>
</pre></div>
</div>
<span class="target" id="module-workbook"></span><dl class="class">
<dt id="workbook.XLSX_Workbook">
<em class="property">class </em><tt class="descclassname">workbook.</tt><tt class="descname">XLSX_Workbook</tt><a class="headerlink" href="#workbook.XLSX_Workbook" title="Permalink to this definition">¶</a></dt>
<dd><p>Extract sheets, rows and cells from an XLSX format file.</p>
<p>We&#8217;re opening a ZIP archive and parsing the various XML documents
that we find therein.</p>
<p>The <tt class="xref py py-class docutils literal"><span class="pre">ElementTree</span></tt> incremental parser provides
parse &#8220;events&#8221; for specific tags, allowing for lower-memory parsing of
the sometimes large XML documents.</p>
<p>See <a class="reference external" href="http://effbot.org/zone/element-iterparse.htm">http://effbot.org/zone/element-iterparse.htm</a></p>
<p>The class as a whole defines some handy constants like XML namespaces
and a pattern for parsing Cell ID&#8217;s to separate the letters from the numbers.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">XLSX_Workbook</span><span class="p">(</span> <span class="n">Workbook</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ECMA Standard XLSX or XLSM documents.</span>
<span class="sd">    Locate sheets and rows within a given sheet.</span>

<span class="sd">    See http://www.ecma-international.org/publications/standards/Ecma-376.htm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Relevant subset of namespaces used</span>
    <span class="n">XLSX_NS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;main&quot;</span><span class="p">:</span><span class="s">&quot;http://schemas.openxmlformats.org/spreadsheetml/2006/main&quot;</span><span class="p">,</span>
    <span class="s">&quot;r&quot;</span><span class="p">:</span><span class="s">&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships&quot;</span><span class="p">,</span>
    <span class="s">&quot;rel&quot;</span><span class="p">:</span><span class="s">&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">cell_id_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="s">r&quot;(\D+)(\d+)&quot;</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the workbook for reading.</span>
<span class="sd">        :param name: File name</span>
<span class="sd">        :param file_object: Optional file-like object.  If omitted, the named file is opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_object</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span> <span class="n">file_object</span> <span class="ow">or</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;r&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare</span><span class="p">()</span>
</pre></div>
</div>
<p>The are two preparation steps required for reading these files.  First, the
sheets must be located.  This involves resolving internal rID numbers.
Second, the shared strings need to be loaded into memory.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_locate_sheets</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_get_shared_strings</span><span class="p">()</span>
</pre></div>
</div>
<p>Locate all sheets involves building a <tt class="xref py py-data docutils literal"><span class="pre">name_to_id</span></tt> mapping and  and <tt class="xref py py-data docutils literal"><span class="pre">id_to_member</span></tt> mapping.  This allows is to map the
user-oriented name to an id and the id to the XLSX zipfile member.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_locate_sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locate the name to id mapping and the id to member mapping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># 1a. Open &quot;workbook.xml&quot; member.</span>
    <span class="n">workbook_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s">&quot;xl/workbook.xml&quot;</span><span class="p">)</span>
    <span class="n">workbook_doc</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_zip</span><span class="p">)</span> <span class="p">)</span>
    <span class="c"># 1b. Get a dict of sheet names and their rIdx values.</span>
    <span class="n">key_attr_id</span><span class="o">=</span> <span class="s">&#39;name&#39;</span>
    <span class="n">val_attr_id</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">],</span> <span class="s">&#39;id&#39;</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key_attr_id</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">val_attr_id</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">workbook_doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;*/main:sheet&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span> <span class="p">)</span>

    <span class="c"># 2a. Open the &quot;_rels/workbook.xml.rels&quot; member</span>
    <span class="n">rels_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s">&quot;xl/_rels/workbook.xml.rels&quot;</span><span class="p">)</span>
    <span class="n">rels_doc</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rels_zip</span><span class="p">)</span> <span class="p">)</span>
    <span class="c"># 2b. Get a dict of rIdx to Target member name</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span> <span class="n">rels_doc</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">key_attr_id</span><span class="o">=</span> <span class="s">&#39;Id&#39;</span>
    <span class="n">val_attr_id</span><span class="o">=</span> <span class="s">&#39;Target&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">id_to_member</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span> <span class="n">r</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key_attr_id</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">val_attr_id</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rels_doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;rel:Relationship&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_member</span> <span class="p">)</span>
</pre></div>
</div>
<p>Get Shared Strings walks a fine line.  Ideally, we&#8217;d like to parse
the document and simply use <tt class="docutils literal"><span class="pre">itertext</span></tt> to gather all of the text
within a given string instance (<tt class="samp docutils literal"><span class="pre">&lt;si&gt;</span></tt>) tag.  <strong>However.</strong></p>
<p>In practice, these documents can be so huge that they don&#8217;t fit
in memory comfortably.  We rely on incremental parsing via the <tt class="docutils literal"><span class="pre">iterparse</span></tt> function.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_shared_strings</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build ``strings_dict`` with all shared strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">count</span><span class="o">=</span> <span class="mi">0</span>
    <span class="n">text_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;t&quot;</span> <span class="p">)</span>
    <span class="n">string_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;si&quot;</span> <span class="p">)</span>
    <span class="c"># 1. Open the &quot;xl/sharedStrings.xml&quot; member</span>
    <span class="n">sharedStrings_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s">&quot;xl/sharedStrings.xml&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">sharedStrings_zip</span> <span class="p">),</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;end&#39;</span><span class="p">,)</span> <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">text_tag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="p">[</span> <span class="n">count</span> <span class="p">]</span><span class="o">+=</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span>
        <span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">string_tag</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">element</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span> <span class="p">)</span>
</pre></div>
</div>
<p>The shared strings may be too massive for in-memory incremental parsing.
We can create a temporary extract file to handle this case. Here&#8217;s
the kind of code we might use.</p>
<pre class="literal-block">
with tempfile.TemporaryFile( ) as temp:
    self.zip_archive.extract( sharedStrings_mbr, temp.filename )
    for event, element in dom.iterparse( temp.filename ):
        <em>process event and element</em>
</pre>
<dl class="method">
<dt id="workbook.XLSX_Workbook.sheets">
<tt class="descclassname">XLSX_Workbook.</tt><tt class="descname">sheets</tt><big>(</big><big>)</big><a class="headerlink" href="#workbook.XLSX_Workbook.sheets" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the list of sheets for this workbook.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sheets</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
<p>Translate a col-row pair from <tt class="samp docutils literal"><span class="pre">(</span><em><span class="pre">letter</span></em><span class="pre">,</span> <em><span class="pre">number</span></em><span class="pre">)</span></tt>
to proper 0-based Python index of <tt class="samp docutils literal"><span class="pre">(</span><em><span class="pre">row</span></em><span class="pre">,</span> <em><span class="pre">col</span></em><span class="pre">)</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">make_row_col</span><span class="p">(</span> <span class="n">col_row_pair</span> <span class="p">):</span>
    <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">col_row_pair</span>
    <span class="n">cn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">col_row_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">*</span><span class="mi">26</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="o">-</span><span class="nb">ord</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="n">cn</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>We can build an eager <a class="reference internal" href="../sheet.html#sheet.Row" title="sheet.Row"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Row</span></tt></a> or a  <a class="reference internal" href="../sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> from the available data.
The eager <a class="reference internal" href="../sheet.html#sheet.Row" title="sheet.Row"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Row</span></tt></a> is built from <a class="reference internal" href="../cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> objects.
The <a class="reference internal" href="../sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> delegates the creation
of <a class="reference internal" href="../cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> objects to <a class="reference internal" href="base.html#workbook.Workbook.row_get" title="workbook.Workbook.row_get"><tt class="xref py py-meth docutils literal"><span class="pre">Workbook.row_get()</span></tt></a>.</p>
<p>This uses an incremental parser, also.  There are four kinds of tags that
have to be located.</p>
<ul class="simple">
<li><tt class="samp docutils literal"><span class="pre">&lt;row&gt;</span><em><span class="pre">row</span></em><span class="pre">&lt;/row&gt;</span></tt>, end event.  Finish (and yield) the row of cells.
Since XLSX is sparse, missing empty cells must be filled in.</li>
<li><tt class="samp docutils literal"><span class="pre">&lt;c</span> <span class="pre">t=&quot;</span><em><span class="pre">type</span></em><span class="pre">&quot;</span> <span class="pre">r=&quot;</span><em><span class="pre">id</span></em><span class="pre">&quot;&gt;</span><em><span class="pre">cell</span></em><span class="pre">&lt;/c&gt;</span></tt>.<ul>
<li>Start event for <tt class="docutils literal"><span class="pre">c</span></tt>.  Get the cell type and id.  Empty the value accumulator.</li>
<li>End event for <tt class="docutils literal"><span class="pre">c</span></tt>.  Save the accumulated value.  This allows the cell to have
mixed content model.</li>
</ul>
</li>
<li><tt class="samp docutils literal"><span class="pre">&lt;v&gt;</span><em><span class="pre">value</span></em><span class="pre">&lt;/v&gt;</span></tt>, end event. Use the <a class="reference internal" href="../cell.html#module-cell" title="cell"><tt class="xref py py-meth docutils literal"><span class="pre">cell()</span></tt></a> method to track down
enough information to build the Cell instance.</li>
</ul>
<dl class="method">
<dt id="workbook.XLSX_Workbook.rows_of">
<tt class="descclassname">XLSX_Workbook.</tt><tt class="descname">rows_of</tt><big>(</big><em>sheet</em><big>)</big><a class="headerlink" href="#workbook.XLSX_Workbook.rows_of" title="Permalink to this definition">¶</a></dt>
<dd><p>Iterate through rows of the given sheet.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">rows_of</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator over rows as a list of Cells for a named worksheet.&quot;&quot;&quot;</span>
    <span class="c"># 1. Map user name to member.</span>
    <span class="n">rId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_id</span><span class="p">[</span><span class="n">sheet</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sheet_member_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_member</span><span class="p">[</span><span class="n">rId</span><span class="p">]</span>
    <span class="c"># 2. Open member.</span>
    <span class="n">sheet_zip</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s">&quot;xl/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">sheet_member_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">=</span> <span class="p">{}</span>
    <span class="c"># 3. Assemble each row, allowing for missing cells.</span>
    <span class="n">row_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;row&quot;</span><span class="p">)</span>
    <span class="n">cell_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;c&quot;</span><span class="p">)</span>
    <span class="n">value_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;v&quot;</span><span class="p">)</span>
    <span class="n">format_tag</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XLSX_NS</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">],</span> <span class="s">&quot;f&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sheet_zip</span><span class="p">),</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;start&#39;</span><span class="p">,</span><span class="s">&#39;end&#39;</span><span class="p">)</span> <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">row_tag</span><span class="p">:</span>
            <span class="c"># End of row: fill in missing cells</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">data</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span> <span class="n">sheet</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">yield</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">stingray</span><span class="o">.</span><span class="n">sheet</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span> <span class="n">sheet</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">=</span> <span class="p">{}</span>
            <span class="n">element</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">cell_tag</span><span class="p">:</span>
            <span class="c"># End of cell: consolidate the final string</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_col</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;start&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">cell_tag</span><span class="p">:</span>
            <span class="c"># Start of cell: collect a string in pieces.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span>
            <span class="n">id_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_row_col</span><span class="p">(</span> <span class="n">id_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">EmptyCell</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">value_tag</span><span class="p">:</span>
            <span class="c"># End of a value; what type was it?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span> <span class="n">element</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">==</span><span class="s">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">format_tag</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># A format string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Ignoring&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">)</span> <span class="c"># Numerous bits of structure exposed.</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">dom</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.XLSX_Workbook.row_get">
<tt class="descclassname">XLSX_Workbook.</tt><tt class="descname">row_get</tt><big>(</big><em>row</em>, <em>attribute</em><big>)</big><a class="headerlink" href="#workbook.XLSX_Workbook.row_get" title="Permalink to this definition">¶</a></dt>
<dd><p>Low-level get of a particular attribute from the given row.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">row_get</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">attribute</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Cell from the row&#39;s data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">position</span><span class="p">]</span>
</pre></div>
</div>
<dl class="method">
<dt id="workbook.XLSX_Workbook.cell">
<tt class="descclassname">XLSX_Workbook.</tt><tt class="descname">cell</tt><big>(</big><em>row</em>, <em>element</em><big>)</big><a class="headerlink" href="#workbook.XLSX_Workbook.cell" title="Permalink to this definition">¶</a></dt>
<dd><p>Build a subclass of <a class="reference internal" href="../cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a> from the current value tag content plus the
containing cell type information.</p>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">cell</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">element</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a proper :py:class:`cell.Cell` subclass from cell and value information.&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">NumberCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&quot;s&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Shared String?</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">)],</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c"># Inline String?</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c"># Not a valid shared string identifier?</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">TextCell</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&quot;b&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">BooleanCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&quot;d&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">FloatDateCell</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">&quot;e&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">ErrorCell</span><span class="p">(</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># &#39;str&#39; (formula), &#39;inlineStr&#39; (string), &#39;e&#39; (error)</span>
        <span class="k">print</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">))</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/Stingray_belon1553_small.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="xls.html"
                        title="previous chapter">8.4. XLS Workbook</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ods.html"
                        title="next chapter">8.6. ODS Workbook</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/workbook/xlsx.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="ods.html" title="8.6. ODS Workbook"
             >next</a> |</li>
        <li class="right" >
          <a href="xls.html" title="8.4. XLS Workbook"
             >previous</a> |</li>
        <li><a href="../index.html">The Stingray Schema-Based File Reader</a> &raquo;</li>
          <li><a href="index.html" >8. Workbook Package &#8211; Uniform Wrappers for Workbooks</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, S. Lott.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>